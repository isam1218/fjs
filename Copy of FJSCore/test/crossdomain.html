<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
</head>
<body>
<script>
    var target = parent.postMessage ? parent : (parent.document.postMessage ? parent.document : undefined);
    var requests = {};
    function doRequest(request){
        var xmlreq, timeout;

        function $process(){
            if (xmlreq.readyState == 4){
                try {
                    if (this.status == 200){
                        request.responseText = xmlreq.responseText;
                        request.status = this.status;
                        var message = {'type':'IFrameAjaxRequest', data:request};
                        target.postMessage(JSON.stringify(message),'*');
                    } else {
                        request.error = xmlreq.statusText;
                        request.status = this.status;
                        request.responseText = xmlreq.responseText;
                        var message = {'type':'IFrameAjaxRequest', data:request};
                        target.postMessage(JSON.stringify(message),'*');
                    }
                }
                catch(e){
                    request.error=e.message;
                    request.status=0;
                    var message = {'type':'IFrameAjaxRequest', data:request};
                    target.postMessage(JSON.stringify(message),'*');
                }
                delete requests[request.id];
            }
        }

        if (XMLHttpRequest){
            xmlreq = new XMLHttpRequest();
        } else if (window.ActiveXObject){
            try {
                xmlreq = new ActiveXObject('Microsoft.XMLHTTP');
            }
            catch (e) {
                try {
                    xmlhttp = new ActiveXObject('Msxml2.XMLHTTP');
                }
                catch (ee) {
                    xmlhttp = false;
                }
            }
        }

        xmlreq.id = request.id;
        requests[request.id] = xmlreq;
        xmlreq.onreadystatechange = $process;
        xmlreq.open(request.method, request.url, true);
        xmlreq.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        for(var key in request.headers) {
            if(request.headers.hasOwnProperty(key)) {
                xmlreq.setRequestHeader(key, request.headers[key]);
            }
        }
        xmlreq.send(getParamData(request.postData));
    }

    function abort(requestId){
        var request = requests[requestId];
        if(request) {
            request.abort();
        }
        var message = {'type':'IFrameAjaxRequest', data:request};
        target.postMessage(JSON.stringify(message), '*');
    }

    var getParamData = function(data) {
        var paramStrings = [], i;
        for (i in data) {
            if (data.hasOwnProperty(i)) {
                paramStrings.push(i + '=' + data[i]);
            }
        }
        return paramStrings.join('&');
    };

    function processMessage(event){
        var message=JSON.parse(event.data);
        if(message) {
            switch (message.type)
            {
                case 'send':
                    doRequest(message.data);
                    break;
                case 'abort':
                    if(requests[message.data.id]) {
                        requests[message.data.id].abort();
                        delete requests[message.data.id];
                    }
                    break;
            }
        }
    }


    if(window.addEventListener)
        window.addEventListener ('message', processMessage, false);
    else if(window.attachEvent)
        window.attachEvent('onmessage', processMessage);
</script>
</body>
</html>