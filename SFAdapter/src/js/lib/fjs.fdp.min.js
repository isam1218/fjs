'use strict';namespace("fjs.db");fjs.db.IndexedDBProvider=function(){this.indexedDB=self.indexedDB||self.mozIndexedDB||self.webkitIndexedDB||self.msIndexedDB;this.IDBTransaction=self.IDBTransaction||self.webkitIDBTransaction||self.msIDBTransaction;this.IDBKeyRange=self.IDBKeyRange||self.webkitIDBKeyRange||self.msIDBKeyRange;this.db=null;this.tables={}};fjs.db.IndexedDBProvider.check=function(){return!(!self.indexedDB&&!self.mozIndexedDB&&!self.webkitIndexedDB&&!self.msIndexedDB)};
fjs.db.IndexedDBProvider.prototype.open=function(b,a,c){var d=this.indexedDB.open(b,a),e=this;d.onerror=function(c){Error("Error: can't open indexedDB ("+b+", "+a+")",c)};var f=function(a){Error("Database error: "+a.target.errorCode)};d.onsuccess=function(){e.db=d.result;e.db.onerror=f;c&&c(e.db)};d.onupgradeneeded=function(a){var b=e.db=a.target.result;for(a.target.transaction.onerror=b.onerror=f;0<b.objectStoreNames.length;)b.deleteObjectStore(b.objectStoreNames[0]);for(var c in e.tables)e.tables.hasOwnProperty(c)&&
(a=e.tables[c],e.createTable(c,a.key,a.indexes))}};fjs.db.IndexedDBProvider.prototype.declareTable=function(b,a,c){b=this.tables[b]={key:a,indexes:c};fjs.utils.Browser.isIE()&&c&&(b.multipleIndexes=this.IEDeclareMultipleIndexes(c))};
fjs.db.IndexedDBProvider.prototype.createTable=function(b,a,c){b=this.db.createObjectStore(b,{keyPath:a});if(c)for(a=0;a<c.length;a++)"[object Array]"==Object.prototype.toString.call(c[a])?fjs.utils.Browser.isIE()?b.createIndex(c[a].join(","),c[a].join(","),{unique:!1}):b.createIndex(c[a].join(","),c[a],{unique:!1}):b.createIndex(c[a],c[a],{unique:!1})};
fjs.db.IndexedDBProvider.prototype.IEDeclareMultipleIndexes=function(b){for(var a={},c=0;c<b.length;c++)"[object Array]"==Object.prototype.toString.call(b[c])&&(a[b[c].join(",")]=b[c]);return a};fjs.db.IndexedDBProvider.prototype.IEApplyMultipleIndexesForItem=function(b,a){var c=this.tables[b].multipleIndexes,d;for(d in c)if(c.hasOwnProperty(d)){for(var e=c[d],f=[],g=0;g<e.length;g++)f.push(null!=a[e[g]]?a[e[g]]:"");a[d]=f.join(",")}};
fjs.db.IndexedDBProvider.prototype.IEClearMultipleIndexesForItem=function(b,a){var c=this.tables[b].multipleIndexes,d;for(d in c)c.hasOwnProperty(d)&&delete a[d]};fjs.db.IndexedDBProvider.prototype.insertOne=function(b,a,c){var d=this.db.transaction([b],"readwrite").objectStore(b);fjs.utils.Browser.isIE()&&this.IEApplyMultipleIndexesForItem(b,a);b=d.put(a);b.onsuccess=function(a){c&&c(a)};b.onerror=this.db.onerror};
fjs.db.IndexedDBProvider.prototype.insertArray=function(b,a,c){for(var d=this.db.transaction([b],"readwrite").objectStore(b),e=a.length,f=0;f<a.length;f++){var g=a[f];fjs.utils.Browser.isIE()&&this.IEApplyMultipleIndexesForItem(b,g);g=d.put(g);g.onsuccess=function(a){e--;c&&0==e&&c(a)};g.onerror=this.db.onerror}};fjs.db.IndexedDBProvider.prototype.deleteByKey=function(b,a,c){b=this.db.transaction([b],"readwrite").objectStore(b);(null!=a?b.delete(a):b.clear()).onsuccess=function(a){c&&c(a)}};
fjs.db.IndexedDBProvider.prototype.selectAll=function(b,a,c){var d=this,e=this.db.transaction([b],"readwrite").objectStore(b),f=this.IDBKeyRange.lowerBound(0),e=e.openCursor(f),g=[];e.onsuccess=function(e){e=e.target.result;if(!1==!!e)c&&c(g);else{var f=e.value;fjs.utils.Browser.isIE()&&d.IEClearMultipleIndexesForItem(b,f);g.push(f);a&&a(f);e.continue()}};e.onerror=this.db.onerror};
fjs.db.IndexedDBProvider.prototype.selectByIndex=function(b,a,c,d){var e=this,f=[],g=[],h;for(h in a)a.hasOwnProperty(h)&&(f.push(h),g.push(a[h]));1==g.length?g=g[0]:fjs.utils.Browser.isIE()&&(g=g.join(","));var a=this.db.transaction([b],"readwrite").objectStore(b).index(f.join(",")),g=this.IDBKeyRange.only(g),g=a.openCursor(g),i=[];g.onsuccess=function(a){a=a.target.result;if(!1==!!a)d&&d(i);else{var f=a.value;fjs.utils.Browser.isIE()&&e.IEClearMultipleIndexesForItem(b,f);i.push(f);c&&c(f);a.continue()}};
g.onerror=this.db.onerror};fjs.db.IndexedDBProvider.prototype.selectByKey=function(b,a,c){var d=this,e=this.db.transaction([b]).objectStore(b).get(a);e.onerror=this.db.onerror;e.onsuccess=function(){var a=e.result;fjs.utils.Browser.isIE()&&d.IEClearMultipleIndexesForItem(b,a);c(a)}};
fjs.db.IndexedDBProvider.prototype.clear=function(b){for(var a=this.db.objectStoreNames.length,c=0;c<this.db.objectStoreNames.length;c++){var d=this.db.transaction([this.db.objectStoreNames[c]],"readwrite").objectStore(this.db.objectStoreNames[c]).clear();d.onsuccess=function(c){a--;b&&0==a&&b(c)};d.onerror=this.db.onerror}};
fjs.db.IndexedDBProvider.prototype.deleteByIndex=function(b,a,c){var d=this,e=[],f=[],g;for(g in a)a.hasOwnProperty(g)&&(e.push(g),f.push(a[g]));1==f.length?f=f[0]:fjs.utils.Browser.isIE()&&(f=f.join(","));var a=this.db.transaction([b],"readwrite").objectStore(b).index(e.join(",")),f=this.IDBKeyRange.only(f),f=a.openCursor(f),h=[];f.onsuccess=function(a){a=a.target.result;if(!1==!!a)c&&c(h);else{var e=a.value;fjs.utils.Browser.isIE()&&d.IEClearMultipleIndexesForItem(b,e);h.push(e);a.delete();a.continue()}};
f.onerror=this.db.onerror};namespace("fjs.db");fjs.db.WebSQLProvider=function(){this.db=null;this.tables={}};fjs.db.WebSQLProvider.check=function(){return"undefined"!==typeof self.openDatabase};
fjs.db.WebSQLProvider.prototype.open=function(b,a,c){var d=this;try{var e=this.db=self.openDatabase(b,"",b,5232645)}catch(f){fjs.utils.Console.error(f);c(null);return}if(""===e.version){for(var g in d.tables)d.tables.hasOwnProperty(g)&&(b=d.tables[g],d.createTable(g,b.key,b.indexes),fjs.utils.Console.log(g+" table created"));c(this)}else e.version!==a?e.changeVersion(e.version,a,function(){d.clear(function(){for(var a in d.tables)if(d.tables.hasOwnProperty(a)){var b=d.tables[a];d.createTable(a,b.key,
b.indexes)}c(this)})}):c(this)};fjs.db.WebSQLProvider.prototype.createTable=function(b,a,c){this.db.transaction(function(d){var e;e="CREATE TABLE IF NOT EXISTS "+(b+"("+a+" TEXT PRIMARY KEY");e+=0<c.length?", "+c.join(" TEXT, ")+" TEXT":"";d.executeSql(e+", data TEXT)");if(c)for(e=0;e<c.length;e++)d.executeSql("CREATE INDEX "+b+"_"+c[e]+"_idx ON "+b+" ("+c[e]+")")})};
fjs.db.WebSQLProvider.prototype.declareTable=function(b,a,c){var d=[];if(c)for(var e=0;e<c.length;e++)if("[object Array]"!=Object.prototype.toString.call(c[e]))d.push(c[e]);else for(var f=0;f<c[e].length;f++){var g=c[e][f];0>c.indexOf(g)&&d.push(g)}this.tables[b]={key:a,indexes:d}};
fjs.db.WebSQLProvider.prototype.insertOne=function(b,a,c){var d=this.tables[b];this.db.transaction(function(e){var f="INSERT OR REPLACE INTO "+b+"("+d.key+", "+(d.indexes&&d.indexes.length?d.indexes.join(", ")+", ":"")+"data) VALUES ('"+a[d.key]+"', '";if(d.indexes)for(var g=0;g<d.indexes.length;g++)f+=a[d.indexes[g]]+"', '";f+=fjs.utils.JSON.stringify(a)+"')";e.executeSql(f,[],c,function(a){throw Error(a);})})};
fjs.db.WebSQLProvider.prototype.insertArray=function(b,a,c){var d=this.tables[b],e=a.length;this.db.transaction(function(f){for(var g="INSERT OR REPLACE INTO "+b+"("+d.key+", "+(d.indexes&&d.indexes.length?d.indexes.join(", ")+", ":"")+"data) VALUES ('",h=0;h<a.length;h++){var i=a[h],j=g+i[d.key]+"', '";if(d.indexes)for(var k=0;k<d.indexes.length;k++)j+=i[d.indexes[k]]+"', '";j+=fjs.utils.JSON.stringify(i)+"')";f.executeSql(j,[],function(){e--;c&&0==e&&c()},function(a){throw Error(a);})}})};
fjs.db.WebSQLProvider.prototype.deleteByKey=function(b,a,c){var d=this.tables[b];this.db.transaction(function(e){var f="DELETE FROM "+b;null!=a&&(f+=" WHERE "+d.key+" = '"+a+"'");e.executeSql(f,[],c,function(a){throw Error(a);})})};
fjs.db.WebSQLProvider.prototype.selectAll=function(b,a,c){this.db.transaction(function(d){d.executeSql("SELECT data FROM "+b,[],function(b,d){var g=[];if(d.rows){for(var h=0;h<d.rows.length;h++){var i=d.rows.item(h).data,i=JSON.parse(i);g.push(i);a&&a(i)}c&&c(g)}},function(a){throw Error(a);})})};
fjs.db.WebSQLProvider.prototype.selectByIndex=function(b,a,c,d){var e="SELECT data FROM "+b+" WHERE ",b=[],f;for(f in a)a.hasOwnProperty(f)&&b.push(f+"='"+a[f]+"'");e+=b.join(" AND ");this.db.transaction(function(a){a.executeSql(e,[],function(a,b){var e=[];if(b.rows){for(var f=0;f<b.rows.length;f++){var g=b.rows.item(f).data,g=JSON.parse(g);e.push(g);c&&c(g)}d&&d(e)}},function(a){throw Error(a);})})};
fjs.db.WebSQLProvider.prototype.selectByKey=function(b,a,c){var d=this;this.db.transaction(function(e){e.executeSql("SELECT data FROM "+b+" WHERE "+d.tables[b].key+"='"+a+"'",[],function(a,b){if(b.rows){var d=b.rows.item(0);d&&d.data?(d=JSON.parse(d.data),c(d)):c(null)}},function(a){throw Error(a);})})};
fjs.db.WebSQLProvider.prototype.clear=function(b){var a=0,c=this;this.db.transaction(function(d){for(var e in c.tables)a++,d.executeSql("DELETE FROM "+e,[],function(){a--;b&&0==a&&b()},function(a){throw Error(a);})})};
fjs.db.WebSQLProvider.prototype.deleteByIndex=function(b,a,c){this.db.transaction(function(d){var e=b;if(null!=a){var e=e+" WHERE ",f=[],g;for(g in a)a.hasOwnProperty(g)&&f.push(g+"='"+a[g]+"'");e+=f.join(" AND ")}d.executeSql("SELECT data FROM "+e,[],function(a,b){var f=[];if(b.rows){for(var g=0;g<b.rows.length;g++){var l=b.rows.item(g).data,l=JSON.parse(l);f.push(l)}d.executeSql("DELETE FROM "+e,[],c(f),function(a){throw Error(a);})}},function(a){throw Error(a);})})};namespace("fjs.db");
fjs.db.LocalStorageDbProvider=function(){this.dbInfo=null;this.tables={};this.dbData={};this.indexes={}};
fjs.db.LocalStorageDbProvider.prototype.createIndexes=function(b,a){var c=this.getLSTableName(b);this.dbData[c]||(this.dbData[c]={});if(this.tables[b].indexes&&0<this.tables[b].indexes.length){var d=this.indexes[c];d||(d=this.indexes[c]={});for(c=0;c<this.tables[b].indexes.length;c++){var e=this.tables[b].indexes[c],f;fjs.utils.Array.isArray(e)&&(f=e,f.sort(),e=f.join("_"));var g=d[e];g||(g=d[e]={});for(var h in a)if(a.hasOwnProperty(h)){var i,j;if(f){i=[];for(j=0;j<f.length;j++)i.push(a[h][f[j]]);
j=i.join("_")}else j=a[h][e];(i=g[j])||(i=g[j]=[]);j=a[h][this.tables[b].key];0>i.indexOf(j)&&i.push(j)}}}};
fjs.db.LocalStorageDbProvider.prototype.open=function(b,a,c){var d,e=this;if(this.dbInfo=fjs.utils.JSON.parse(self.localStorage.getItem("DB_"+b)))if(a>this.dbInfo.version){for(var f=0;f<this.dbInfo.tables.length;f++)d=this.dbInfo.tables[f],self.localStorage.removeItem(d);this.dbInfo.tables=null;this.dbInfo.version=a;this.createTables();self.localStorage.setItem("DB_"+b,fjs.utils.JSON.stringify(this.dbInfo))}else for(b=0;b<this.dbInfo.tables.length;b++)d=this.dbInfo.tables[b],a=this.dbData[d]=fjs.utils.JSON.parse(self.localStorage.getItem(d))||
{},this.createIndexes(this.getRealTableName(d),a);else this.dbInfo={name:b,version:a},this.createTables(),self.localStorage.setItem("DB_"+b,fjs.utils.JSON.stringify(this.dbInfo));c&&setTimeout(function(){c(e)},0)};fjs.db.LocalStorageDbProvider.check=function(){return!!self.localStorage};fjs.db.LocalStorageDbProvider.prototype.createTable=function(){};
fjs.db.LocalStorageDbProvider.prototype.createTables=function(){if(this.tables){this.dbInfo.tables=[];for(var b in this.tables)this.tables.hasOwnProperty(b)&&this.dbInfo.tables.push(this.getLSTableName(b))}};fjs.db.LocalStorageDbProvider.prototype.getLSTableName=function(b){return"DB_"+this.dbInfo.name+"_"+b};fjs.db.LocalStorageDbProvider.prototype.getRealTableName=function(b){return b.replace("DB_"+this.dbInfo.name+"_","")};
fjs.db.LocalStorageDbProvider.prototype.declareTable=function(b,a,c){this.tables[b]={name:b,key:a,indexes:c}};fjs.db.LocalStorageDbProvider.prototype.insertOne=function(b,a,c){var d=this.getLSTableName(b);this.createIndexes(b,[a]);this.dbData[d][a[this.tables[b].key]]=a;self.localStorage.setItem(d,fjs.utils.JSON.stringify(this.dbData[d]));c&&setTimeout(c,0)};
fjs.db.LocalStorageDbProvider.prototype.insertArray=function(b,a,c){var d=this.getLSTableName(b);this.createIndexes(b,a);for(var e=0;e<a.length;e++){var f=a[e];this.dbData[d][f[this.tables[b].key]]=f}self.localStorage.setItem(d,fjs.utils.JSON.stringify(this.dbData[d]));c&&setTimeout(c,0)};
fjs.db.LocalStorageDbProvider.prototype.deleteByKey=function(b,a,c){b=this.getLSTableName(b);null!=a&&this.dbData[b]?delete this.dbData[b][a]:(this.dbData[b]={},this.indexes[b]={});self.localStorage.setItem(b,fjs.utils.JSON.stringify(this.dbData[b]));c&&setTimeout(c,0)};
fjs.db.LocalStorageDbProvider.prototype.selectAll=function(b,a,c){var b=this.getLSTableName(b),d=[],e=this.dbData[b],b=0,f;for(f in e)e.hasOwnProperty(f)&&(b++,function(b,f){setTimeout(function(){var i=e[b];d.push(i);a(i);--f;0===f&&setTimeout(function(){c(d)},0)},0)}(f,b));0===b&&setTimeout(function(){c(d)},0)};
fjs.db.LocalStorageDbProvider.prototype.selectByIndex=function(b,a,c,d){var e=[],f=[],g=[],h=this.getLSTableName(b),i=[],j,k,l=this,m=0;if(a){for(var n in a)a.hasOwnProperty(n)&&f.push(n);if(1<f.length){f.sort();j=f.join("_");for(b=0;b<f.length;b++)g.push(a[f[b]]);k=g.join("_")}else 1==f.length&&(j=f[0],k=a[j]);if((i=this.indexes[h]&&this.indexes[h][j]&&this.indexes[h][j][k])&&0<i.length)for(a=0;a<i.length;a++)m++,function(a,b){setTimeout(function(){var f=l.dbData[h][i[a]];e.push(f);c(f);--b;0==b&&
setTimeout(function(){d(e)},0)},0)}(a,m);else setTimeout(function(){d(e)},0)}else this.selectAll(b,c,d)};fjs.db.LocalStorageDbProvider.prototype.selectByKey=function(b,a,c){b=this.getLSTableName(b);setTimeout(c(this.dbData[b][a]),0)};fjs.db.LocalStorageDbProvider.prototype.clear=function(b){for(var a in this.tables)if(this.tables.hasOwnProperty(a)){var c=this.getLSTableName(a);self.localStorage.removeItem(c);delete this.dbData[c];delete this.indexes[c]}b&&setTimeout(b,0)};
fjs.db.LocalStorageDbProvider.prototype.deleteByIndex=function(b,a,c){var d=[],e=[],f=[],b=this.getLSTableName(b),g=[],h,i;if(null==a){for(var j in this.dbData[b])this.dbData[b].hasOwnProperty(j)&&(d.push(this.dbData[b][j]),delete this.dbData[b][j]);this.indexes[b]={};self.localStorage.setItem(b,fjs.utils.JSON.stringify(this.dbData[b]))}else{for(var k in a)a.hasOwnProperty(k)&&e.push(k);if(1<e.length){e.sort();h=e.join("_");for(g=0;g<e.length;g++)f.push(a[e[g]]);i=f.join("_")}else 1==e.length&&(h=
e[0],i=a[h]);if(g=this.indexes[b]&&this.indexes[b][h]&&this.indexes[b][h][i])for(a=0;a<g.length;a++)d.push(this.dbData[b][g[a]]),delete this.dbData[b][g[a]]}setTimeout(function(){c(d)},0)};namespace("fjs.db");fjs.db.DBFactory=function(b){this.config=b;this._dbRegister={indexedDB:fjs.db.IndexedDBProvider,webSQL:fjs.db.WebSQLProvider,localStorage:fjs.db.LocalStorageDbProvider}};fjs.db.DBFactory.prototype.getDB=function(){for(var b=this.config.DB.dbProviders,a=0;a<b.length;a++)if(this._dbRegister[b[a]].check())return new this._dbRegister[b[a]]};
namespace("fjs.fdp.model");fjs.fdp.model.EntryModel=function(b){this.xpid=this.xef001iver=this.xef001id=null;this.fill(b)};fjs.fdp.model.EntryModel.prototype.fill=function(b){var a={},c=0;if(b)for(var d in b)b.hasOwnProperty(d)&&this[d]!=b[d]&&(this[d]=b[d],a[d]=this[d],c++);return c?(a.xpid||(a.xpid=this.xpid),a):null};namespace("fjs.fdp.model");
fjs.fdp.model.ProxyModel=function(b,a){var c=this;this.items={};this.keepEntries={};this.changes=null;this.feeds=b;this.feedName=b[0];this.listeners=[];this.feedFields={};this.sm=a;this._attached=!1;var d=function(a){c.onSyncEvent(a)};this.attach=function(){for(var a=0;a<this.feeds.length;a++)this.sm.addFeedListener(this.feeds[a],d)};this.detach=function(){for(var a=0;a<this.feeds.length;a++)this.sm.removeFeedListener(this.feeds[a],d)}};
fjs.fdp.model.ProxyModel.prototype.addListener=function(b){if(0>this.listeners.indexOf(b)){this.listeners.push(b);var a=this.createFullChange();a&&b({feed:this.feedName,changes:a});this._attached||(this.attach(),this._attached=!0)}else fjs.utils.Console.warn("Trying to add duplicated listener")};fjs.fdp.model.ProxyModel.prototype.removeListener=function(b){b=this.listeners.indexOf(b);-1<b?(this.listeners.splice(b,1),0==this.listeners.length&&(this.detach(),this._attached=!1)):fjs.utils.Console.warn("Trying to remove unexisted listener")};
fjs.fdp.model.ProxyModel.prototype.fireEvent=function(b){for(var a=this.listeners.slice(0),c=0;c<a.length;c++)if(-1<this.listeners.indexOf(a[c]))a[c](b)};fjs.fdp.model.ProxyModel.prototype.createChange=function(b){this.changes||(this.changes={});var a=this.changes[b];a||(a=this.changes[b]={xpid:b,entry:{}});return a};
fjs.fdp.model.ProxyModel.prototype.createFullChange=function(){var b={},a=0,c;for(c in this.items)this.items.hasOwnProperty(c)&&(b[c]={xpid:c,entry:this.items[c],type:"change"},a++);return 0<a?b:null};fjs.fdp.model.ProxyModel.prototype.fillChange=function(b,a,c){this.collectFields(c,a);b=this.createChange(b);if("delete"!=b.type){b.type="change";for(var d in a)a.hasOwnProperty(d)&&this.fieldPass(c,d,!0)&&(b.entry[d]=a[d])}else fjs.utils.Console.error("Change for deleted entry");return b};
fjs.fdp.model.ProxyModel.prototype.fillDeletion=function(b,a){var c=this.createChange(b);if(a==this.feedName)c.type="delete",c.entry=null;else{if("delete"==c.type)return c;c.type="change";var d=this.feedFields[a];if(d){if(this.items[b])for(var e in d)d.hasOwnProperty(e)&&e in this.items[b]&&(delete this.items[b][e],c.entry[e]=d[e]);else fjs.utils.Console.error("Trying to remove unexisted element:",b);fjs.utils.JSON.isEmpty(c.entry)&&(delete this.changes[b],c=null,fjs.utils.JSON.isEmpty(this.changes)&&
(this.changes=null))}}return c};fjs.fdp.model.ProxyModel.prototype.fieldPass=function(b,a,c){return b!=this.feedName?a!=b+"_xef001id"&&a!=b+"_xef001iver"&&a!=b+"_xef001type"&&a!=b+"_xpid"&&a!=b+"_source"&&("xpid"!=a||c):("xpid"!=a||c)&&"xef001id"!=a&&"xef001iver"!=a&&"xef001type"!=a&&"source"!=a};
fjs.fdp.model.ProxyModel.prototype.collectFields=function(b,a){if(b!=this.feedName&&!this.feedFields[b]){this.feedFields[b]={};for(var c in a)a.hasOwnProperty(c)&&this.fieldPass(b,c,!1)&&(this.feedFields[b][c]=null)}};fjs.fdp.model.ProxyModel.prototype.prepareEntry=function(b,a,c){var d={},e,a=a!=this.feedName?a+"_":"";for(e in b)b.hasOwnProperty(e)&&(d[a+e]=b[e]);d.xpid=c;return d};
fjs.fdp.model.ProxyModel.prototype.onEntryChange=function(b){var a=this.items[b.xpid],c=this.prepareEntry(b.entry,b.feed,b.xpid);a?(a=a.fill(c))&&this.fillChange(b.xpid,a,b.feed):"delete"!=this.fillChange(b.xpid,c,b.feed).type&&(this.items[b.xpid]=new fjs.fdp.model.EntryModel(c));this.keepEntries[b.xpid]=b};fjs.fdp.model.ProxyModel.prototype.onEntryDeletion=function(b){b.feed==this.feedName&&delete this.items[b.xpid];this.fillDeletion(b.xpid,b.feed)};
fjs.fdp.model.ProxyModel.prototype.onEntryKeep=function(b){this.keepEntries[b.xpid]=b};fjs.fdp.model.ProxyModel.prototype.onSourceComplete=function(b){if(b.syncType==fjs.fdp.SyncManager.syncTypes.FULL||b.syncType==fjs.fdp.SyncManager.syncTypes.KEEP)for(var a in this.items)if(this.items.hasOwnProperty(a)&&b.sourceId==this.items[a].source&&!this.keepEntries[a])this.onEntryDeletion({eventType:fjs.fdp.SyncManager.eventTypes.ENTRY_DELETION,feed:b.feed,xpid:a,entry:null});this.keepEntries={}};
fjs.fdp.model.ProxyModel.prototype.onSyncEvent=function(b){var a=fjs.fdp.SyncManager.eventTypes;switch(b.eventType){case a.ENTRY_CHANGE:this.onEntryChange(b);break;case a.ENTRY_DELETION:this.onEntryDeletion(b);break;case a.ENTRY_KEEP:this.onEntryKeep(b);break;case a.SOURCE_COMPLETE:this.onSourceComplete(b);break;case a.SYNC_COMPLETE:this.onSyncComplete(b)}};
fjs.fdp.model.ProxyModel.prototype.onSyncComplete=function(){this.changes&&this.fireEvent({feed:this.feedName,changes:this.changes});this.changes=null};fjs.fdp.model.ProxyModel.prototype.sendAction=function(b,a,c){this.sm.sendAction(b,a,c)};namespace("fjs.fdp.model");
fjs.fdp.model.ClientFeedProxyModel=function(b,a){fjs.fdp.model.ProxyModel.call(this,b,a);var c=this;this.clientFeedName=b[b.length-1];var d=function(a){c.onSyncEvent(a)};this.attach=function(){for(var a=0;a<this.feeds.length;a++)this.sm.addFeedListener(this.feeds[a],d,this.feeds[a]==this.clientFeedName)};this.detach=function(){for(var a=0;a<this.feeds.length;a++)this.sm.removeFeedListener(this.feeds[a],d,this.feeds[a]==this.clientFeedName)}};fjs.fdp.model.ClientFeedProxyModel.extend(fjs.fdp.model.ProxyModel);
fjs.fdp.model.ClientFeedProxyModel.prototype.createSyncData=function(b,a){var c={};a.xef001type=b;c[this.clientFeedName]={"":{items:[a],xef001type:"L"}};return c};fjs.fdp.model.ClientFeedProxyModel.prototype.onSyncComplete=function(){this.changes&&this.fireEvent({feed:this.clientFeedName,changes:this.changes});this.changes=null};
fjs.fdp.model.ClientFeedProxyModel.prototype.sendAction=function(b,a,c,d){"push"===a||"delete"===a?(b=this.createSyncData(a,c),this.sm.onClientSync(fjs.utils.JSON.stringify(b),d)):this.superClass.sendAction.call(this,this.feedName,a,c)};fjs.fdp.model.ClientFeedProxyModel.prototype.onEntryDeletion=function(b){b.feed==this.feedName&&(delete this.items[b.xpid],this.sendAction(this.clientFeedName,"delete",{xpid:b.xpid},!0));this.fillDeletion(b.xpid,b.feed)};
fjs.fdp.model.ClientFeedProxyModel.prototype.addListener=function(b){if(0>this.listeners.indexOf(b)){this.listeners.push(b);var a=this.createFullChange();a&&b({feed:this.clientFeedName,changes:a});this._attached||(this.attach(),this._attached=!0)}else fjs.utils.Console.warn("Trying to add duplicated listener")};
fjs.fdp.model.ClientFeedProxyModel.prototype.collectFields=function(b,a){if(b!=this.feedName){this.feedFields[b]||(this.feedFields[b]={});for(var c in a)a.hasOwnProperty(c)&&this.fieldPass(b,c,!1)&&(this.feedFields[b][c]=null)}};
fjs.fdp.model.ClientFeedProxyModel.prototype.onEntryChange=function(b){var a=this.items[b.xpid],c=this.prepareEntry(b.entry,b.feed,b.xpid);if(a)(a=a.fill(c))&&this.fillChange(b.xpid,a,b.feed);else{if(b.feed==this.clientFeedName&&this.clientFeedName!=this.feedName)return;"delete"!=this.fillChange(b.xpid,c,b.feed).type&&(this.items[b.xpid]=new fjs.fdp.model.EntryModel(c))}this.keepEntries[b.xpid]=b};
(function(){namespace("fjs.fdp.transport");fjs.fdp.transport.FDPTransport=function(b,a,c){fjs.EventsSource.call(this);this.ticket=b;this.node=a;this.url=c};fjs.fdp.transport.FDPTransport.extend(fjs.EventsSource);fjs.fdp.transport.FDPTransport.prototype.send=function(){};fjs.fdp.transport.FDPTransport.prototype.close=function(){}})();
(function(){namespace("fjs.fdp.transport");fjs.fdp.transport.AJAXTransport=function(b,a,c,d){fjs.fdp.transport.FDPTransport.call(this,b,a,c);this.ajax=null;this.type=d;this._forgetFeeds=[];this._clientRegistryFailedCount=0;this._currentRequest=this._currentVersioncache=null;this.VERSIONS_PATH="/v1/versions";this.VERSIONSCACHE_PATH="/v1/versionscache";this.CLIENT_REGISRY_PATH="/accounts/ClientRegistry";this.SYNC_PATH="/v1/sync";this.SF_LOGIN_PATH="/accounts/salesforce";this.closed=!1;this.versionsCacheFailedCount=
0;this.isNetworkProblem=!0};fjs.fdp.transport.AJAXTransport.extend(fjs.fdp.transport.FDPTransport);fjs.fdp.transport.AJAXTransport.prototype.sendRequest=function(){};fjs.fdp.transport.AJAXTransport.prototype.handleRequestErrors=function(b,a){if(!a&&0==b.status&&!b.aborted)this.fireEvent("error",{type:"networkProblem"}),this.isNetworkProblem=!0;else{if(!a){var c={type:"requestError",requestUrl:b.url,message:"Request failed",status:b.status};this.fireEvent("error",c);fjs.utils.Console.error(c)}this.isNetworkProblem&&
(this.fireEvent("message",{type:"connectionEstablished"}),this.isNetworkProblem=!1)}};fjs.fdp.transport.AJAXTransport.prototype.send=function(b){switch(b.type){case "action":this.sendAction(b.data.feedName,b.data.actionName,b.data.parameters);break;case "loadNext":this.loadNext(b);break;case "synchronize":this.requestVersions(b.data.versions);break;case "forget":this._forgetFeed(b.data.feedName);break;case "SFLogin":this.SFLogin(b.data)}};fjs.fdp.transport.AJAXTransport.prototype.SFLogin=function(b){var a=
this;this._currentRequest=this.sendRequest(this.url+this.SF_LOGIN_PATH,b,function(b,d,e){if(e){var f=fjs.utils.JSON.parse(d),d=f.Auth,f=f.node;d&&f?(a.fireEvent("message",{type:"node",data:{nodeId:a.node=f}}),a.fireEvent("message",{type:"ticket",data:{ticket:a.ticket=d}})):a.fireEvent("error",{type:"authError",message:"Can't get ticket or node"})}else(403==b.status||401==b.status)&&a.fireEvent("error",{type:"authError",message:"Wrong auth data"});a.handleRequestErrors(b,e)})};fjs.fdp.transport.AJAXTransport.prototype.loadNext=
function(b){var a=b.data,c=this;this._currentRequest=this.sendRequest(this.url+"/v1/history/"+a.feedName,a.data,function(b,e,f){if(f){var e=fjs.utils.JSON.parse(e),g={};g[a.feedName]=e;for(var h in e)e.hasOwnProperty(h)&&(e[h].filter=a.data["sh.filter"]);c.fireEvent("message",{type:"sync",data:g})}c.handleRequestErrors(b,f)})};fjs.fdp.transport.AJAXTransport.prototype._forgetFeed=function(b){0>this._forgetFeeds.indexOf(b)&&this._forgetFeeds.push(b)};fjs.fdp.transport.AJAXTransport.prototype.parseClientRegistryResponse=
function(b){for(var b=b.split("\n"),a={},c=0;c<b.length;c++)if(-1<b[c].indexOf("=")){var d=b[c].split("="),e=d[0].trim(),d=d[1].trim();e&&d&&(a[e]=d)}return a};fjs.fdp.transport.AJAXTransport.prototype.requestClientRegistry=function(b){var a=this;this._currentRequest=this.sendRequest(this.url+this.CLIENT_REGISRY_PATH,{},function(c,d,e){if(e){a._clientRegistryFailedCount=0;var f=a.parseClientRegistryResponse(d).node;f&&(a.fireEvent("message",{type:"node",data:{nodeId:a.node=f}}),b(d))}else 403==c.status?
(b(!1),a.fireEvent("error",{type:"authError",message:"Auth ticket wrong or expired"})):10>a._clientRegistryFailedCount?(a._clientRegistryFailedCount++,a.requestClientRegistry(b)):b(!1);a.handleRequestErrors(c,e)})};fjs.fdp.transport.AJAXTransport.prototype.requestVersionscache=function(){var b=this;this._currentRequest=this._currentVersioncache=this.sendRequest(this.url+this.VERSIONSCACHE_PATH,null,function(a,c,d){d?(b._clientRegistryFailedCount=0,(c=b.parseVersionsResponse(c))?b.syncRequest(c):b.requestVersionscache()):
401==a.status||403==a.status?b.requestClientRegistry(function(a){a&&b.requestVersionscache()}):a.aborted||(5>b._clientRegistryFailedCount?(b.requestVersionscache(),b._clientRegistryFailedCount++):5<=b._clientRegistryFailedCount&&setTimeout(function(){b.requestVersionscache()},5E3));b.handleRequestErrors(a,d)})};fjs.fdp.transport.AJAXTransport.prototype.syncRequest=function(b){var a=this;this._currentRequest=this.sendRequest(this.url+this.SYNC_PATH,b,function(b,d,e){e&&(d=fjs.utils.JSON.parse(d),a.fireEvent("message",
{type:"sync",data:d}),a.requestVersionscache());a.handleRequestErrors(b,e)})};fjs.fdp.transport.AJAXTransport.prototype.parseVersionsResponse=function(b){var b=b.split(";"),a={},c=0,d;if(b)for(var e=2;e<b.length-1;e++)b[e]&&(0>(d=this._forgetFeeds.indexOf(b[e]))?a[b[e]]="":this._forgetFeeds.splice(d,1),c++);return c?a:null};fjs.fdp.transport.AJAXTransport.prototype.requestVersions=function(b){var a=this;null!=this._currentVersioncache&&this.ajax.abort(this._currentVersioncache);if(!this.node)return this.requestClientRegistry(function(c){c&&
a.requestVersions(b)});this._currentVersioncache=this._currentRequest=this.sendRequest(this.url+this.VERSIONS_PATH,b,function(c,d,e){e?(d=a.parseVersionsResponse(d))?a.syncRequest(d):a.requestVersionscache():(401==c.status||403==c.status)&&a.requestClientRegistry(function(c){c&&a.requestVersions(b)});a.handleRequestErrors(c,e)})};fjs.fdp.transport.AJAXTransport.prototype.sendAction=function(b,a,c){var d=this,a={action:a},e;for(e in c)c.hasOwnProperty(e)&&(a["a."+e]=c[e]);this.sendRequest(this.url+
"/v1/"+b,a,function(a,b,c){d.handleRequestErrors(a,c)})};fjs.fdp.transport.AJAXTransport.prototype.close=function(){this.closed=!0;this._currentRequest&&this.ajax.abort(this._currentRequest)}})();
(function(){namespace("fjs.fdp");fjs.fdp.transport.XHRTransport=function(b,a,c,d){fjs.fdp.transport.AJAXTransport.call(this,b,a,c,d);this.ajax=new fjs.ajax.XHRAjax};fjs.fdp.transport.XHRTransport.extend(fjs.fdp.transport.AJAXTransport);fjs.fdp.transport.XHRTransport.prototype.sendRequest=function(b,a,c){if(this.closed)return null;a=a||{};a.t=this.type;a.alt="j";a=this.ajax.send("post",b,{Authorization:"auth="+this.ticket,node:this.node||""},a,c);a.url=b;return a}})();
(function(){namespace("fjs.fdp");fjs.fdp.transport.XDRTransport=function(b,a,c,d){fjs.fdp.transport.AJAXTransport.call(this,b,a,c,d);this.ajax=new fjs.ajax.XDRAjax;this.iframeAjax=new fjs.ajax.IFrameAjax(c+"/v1/CrossDomain")};fjs.fdp.transport.XDRTransport.extend(fjs.fdp.transport.AJAXTransport);fjs.fdp.transport.XDRTransport.prototype.sendRequest=function(b,a,c){var d=this;if(this.closed)return null;a=a||{};a.t=this.type;a.alt="j";var e={Authorization:this.ticket,node:this.node},f=this.ajax.send("post",
b,e,a,function(f,h,i){i?c.apply(this,arguments):d.iframeAjax.send("post",b,e,a,c)});f.url=b;return f}})();
(function(){namespace("fjs.fdp.transport");fjs.fdp.transport.IFrameTransport=function(b,a,c,d,e){fjs.fdp.transport.AJAXTransport.call(this,b,a,c,d);this.ajax=new fjs.ajax.IFrameAjax(e)};fjs.fdp.transport.IFrameTransport.extend(fjs.fdp.transport.AJAXTransport);fjs.fdp.transport.IFrameTransport.prototype.sendRequest=function(b,a,c){if(this.closed)return null;a=a||{};a.t=this.type;a.alt="j";return this.ajax.send("post",b,{Authorization:"auth="+this.ticket,node:this.node},a,c)}})();
(function(){namespace("fjs.fdp.transport");fjs.fdp.transport.LocalStorageTransport=function(){var b=this;fjs.fdp.transport.FDPTransport.call(this);this.onStorage=function(a){if(-1<a.key.indexOf("lsp_")){var c=a.key.replace("lsp_","");b.fireEvent(c,fjs.utils.JSON.parse(a.newValue))}};window.addEventListener("storage",this.onStorage,!1)};fjs.fdp.transport.LocalStorageTransport.extend(fjs.fdp.transport.FDPTransport);fjs.fdp.transport.LocalStorageTransport.prototype.send=function(b){localStorage["lsp_"+
b.type]=fjs.utils.JSON.stringify(b.data)};fjs.fdp.transport.LocalStorageTransport.prototype.close=function(){window.removeEventListener("storage",this.onStorage,!1)};fjs.fdp.transport.LocalStorageTransport.masterSend=function(b,a){localStorage["lsp_"+b]=fjs.utils.JSON.stringify(a)}})();
(function(){fjs.fdp.transport.TransportFactory=function(){};fjs.fdp.transport.TransportFactory.getTransport=function(b,a,c,d){var e;if(fjs.fdp.transport.TransportFactory.useLocalStorageSyncronization())e=(new fjs.api.TabsSynchronizer).isMaster;else return new fjs.fdp.transport.XHRTransport(b,a,c,d);if(null!=e)if(e)this._getBrowserSpecifiedTransport(b,a,c,d);else return new fjs.fdp.transport.LocalStorageTransport;return this._getBrowserSpecifiedTransport(b,a,c,d)};fjs.fdp.transport.TransportFactory._getBrowserSpecifiedTransport=
function(b,a,c,d){return fjs.utils.Browser.isIE()&&10>fjs.utils.Browser.getIEVersion()?new fjs.fdp.transport.XDRTransport(b,a,c,d):new fjs.fdp.transport.XHRTransport(b,a,c,d)};fjs.fdp.transport.TransportFactory.useLocalStorageSyncronization=function(){return"undefined"!==typeof window&&void 0!==window.document||self&&self.web_worker}})();
(function(){namespace("fjs.fdp");fjs.fdp.SyncManager=function(a){if(this.constructor.__instance)return this.constructor.__instance;this.constructor.__instance=this;fjs.EventsSource.call(this);this.db=(new fjs.db.DBFactory(a)).getDB();this.syncs=[];this.status=b.states.NOT_INITIALIZED;this.config=a;this.transport=null;this.versions={};this.historyversions={};this.node=this.ticket=null;this.serverHost=this.config.SERVER.serverURL;this.type=this.config.CLIENT.type;this.syncFeeds=[];this.suspendFeeds=
[];this.suspendClientFeeds=[];this.versionsFeeds=[];this.versionsTimeoutId=null;this.feeds=[];this.suspendLoginData=this.tabsSyncronizer=null};fjs.fdp.SyncManager.extend(fjs.EventsSource);var b=fjs.fdp.SyncManager;fjs.fdp.SyncManager.states={NOT_INITIALIZED:-1,INITIALIZATION:0,READY:1};fjs.fdp.SyncManager.eventTypes={SYNC_START:"syncStart",SYNC_COMPLETE:"syncComplete",FEED_START:"feedStart",FEED_COMPLETE:"feedComplete",SOURCE_START:"sourceStart",SOURCE_COMPLETE:"sourceComplete",ENTRY_CHANGE:"push",
ENTRY_DELETION:"delete",ENTRY_KEEP:"keep"};fjs.fdp.SyncManager.syncTypes={FULL:"F",KEEP:"I",LAZY:"L",HISTORY:"H"};fjs.fdp.SyncManager.prototype.init=function(a,c,d){var e=this;this.status=b.states.INITIALIZATION;this.ticket=a;this.node=c;fjs.fdp.transport.TransportFactory.useLocalStorageSyncronization()&&(self.addEventListener("storage",function(a){e.onStorage(a)},!1),this.tabsSyncronizer=new fjs.api.TabsSynchronizer,this.tabsSyncronizer.addEventListener("master_changed",function(){e.onMasterChanged()}));
this.transport=fjs.fdp.transport.TransportFactory.getTransport(this.ticket,this.node,this.serverHost,this.type);this.addTransportEvents();this.initDataBase(d)};fjs.fdp.SyncManager.prototype.onMasterChanged=function(){this.transport.close();this.transport=fjs.fdp.transport.TransportFactory.getTransport(this.ticket,this.node,this.serverHost,this.type);this.addTransportEvents();clearTimeout(this.versionsTimeoutId);this.startSync(this.syncFeeds)};fjs.fdp.SyncManager.prototype.onStorage=function(a){if(-1<
a.key.indexOf("lsp_")){var b=a.key.replace("lsp_","");if((new fjs.api.TabsSynchronizer).isMaster)if(a=fjs.utils.JSON.parse(a.newValue),"clientSync"==b)this.onClientSync(a);else this.transport.send({type:b,data:a})}};fjs.fdp.SyncManager.prototype.addTransportEvents=function(){var a=this;this.transport.addEventListener("message",function(b){fjs.fdp.transport.TransportFactory.useLocalStorageSyncronization()&&(new fjs.api.TabsSynchronizer).isMaster&&fjs.fdp.transport.LocalStorageTransport.masterSend("message",
b);switch(b.type){case "sync":a.onSync(b.data);break;case "ticket":a.fireEvent("ticket",b);a.startSync(a.syncFeeds);break;default:a.fireEvent(b.type,b)}});this.transport.addEventListener("error",function(b){fjs.fdp.transport.TransportFactory.useLocalStorageSyncronization()&&(new fjs.api.TabsSynchronizer).isMaster&&fjs.fdp.transport.LocalStorageTransport.masterSend("error",b);switch(b.type){default:a.fireEvent(b.type,b)}})};fjs.fdp.SyncManager.prototype.initDataBase=function(a){if(this.db){for(var b=
this,d=0;d<this.config.DB.tables.length;d++){var e=this.config.DB.tables[d];this.db.declareTable(e.name,e.key,e.indexes)}this.db.open(this.config.DB.name,this.config.DB.version,function(d){d||(b.db=null);b.finishInitialization(a)})}else this.finishInitialization(a)};fjs.fdp.SyncManager.prototype.getDataForFeeds=function(a,c){var d=this;fjs.utils.Core.asyncForIn(a,function(a,c,g){d.getFeedData(c,function(a){d.fireEvent(a.feed,a);a.eventType==b.eventTypes.FEED_COMPLETE&&g()})},function(){c()})};fjs.fdp.SyncManager.prototype.finishInitialization=
function(a){function c(){0<d.suspendFeeds.length&&d.startSync(d.suspendFeeds);d.suspendFeeds=[];d.suspendClientFeeds=[];d.status=b.states.READY;a()}var d=this;if(this.suspendLoginData){var e=this.suspendLoginData;this.db?this.db.clear(function(){d.transport.send({type:"SFLogin",data:e});c()}):(d.transport.send({type:"SFLogin",data:e}),c());this.suspendLoginData=null}else 0<this.suspendFeeds.length?(this.fireEvent(null,{eventType:b.eventTypes.SYNC_START}),this.getDataForFeeds(this.suspendFeeds,function(){0<
d.suspendClientFeeds.length?d.getDataForFeeds(d.suspendClientFeeds,function(){d.fireEvent(null,{eventType:b.eventTypes.SYNC_COMPLETE});c()}):(d.fireEvent(null,{eventType:b.eventTypes.SYNC_COMPLETE}),c())})):0<this.suspendClientFeeds.length?(this.fireEvent(null,{eventType:b.eventTypes.SYNC_START}),this.getDataForFeeds(this.suspendClientFeeds,function(){d.fireEvent(null,{eventType:b.eventTypes.SYNC_COMPLETE});c()})):c()};fjs.fdp.SyncManager.prototype.startSync=function(a){var b={},d=this;a?fjs.utils.Core.asyncForIn(a,
function(a,f,g){d.getVersions(f,b,function(){g()})},function(){d.transport.send({type:"synchronize",data:{versions:b}})}):Error("You must set feeds names array")};fjs.fdp.SyncManager.prototype.saveVersions=function(a,b,d){this.db&&(void 0!==d&&(!fjs.fdp.transport.TransportFactory.useLocalStorageSyncronization()||(new fjs.api.TabsSynchronizer).isMaster))&&this.db.insertOne("versions",{feedSource:a+"_"+b,feedName:a,source:b,version:d})};fjs.fdp.SyncManager.prototype.getVersions=function(a,b,d){var e=
[],f=this;this.versions[a]?setTimeout(function(){d(b[a]=f.versions[a])},0):this.db?this.db.selectByIndex("versions",{feedName:a},function(a){e.push(a.source+"@"+a.version)},function(){f.versions[a]=b[a]=e.join(",");d(b[a])}):setTimeout(function(){d(f.versions[a]=b[a]="")},0)};fjs.fdp.SyncManager.prototype.lazySyncProcessItems=function(a,c,d){for(var e=[],f=0;f<a.length;f++){var g=a[f],h=g.xef001type||b.eventTypes.ENTRY_CHANGE,i=g.xpid=g.xpid?g.xpid:d?d+"_"+g.xef001id:g.xef001id;delete g.xef001type;
g.source=d;g={eventType:h,feed:c,xpid:i,entry:g};if(this.db)switch(h){case b.eventTypes.ENTRY_CHANGE:e.push(g.entry);break;case b.eventTypes.ENTRY_DELETION:(!fjs.fdp.transport.TransportFactory.useLocalStorageSyncronization()||(new fjs.api.TabsSynchronizer).isMaster)&&this.db.deleteByKey(c,g.xpid,null);break;default:fjs.utils.Console.error("Incorrect item change type: "+h+" for Lazy sync")}this.fireEvent(c,g)}this.db&&(0<e.length&&(!fjs.fdp.transport.TransportFactory.useLocalStorageSyncronization()||
(new fjs.api.TabsSynchronizer).isMaster))&&this.db.insertArray(c,e,null)};fjs.fdp.SyncManager.prototype.fullSyncProcessItems=function(a,c,d){for(var e=this,f=[],g=0;g<a.length;g++){var h=a[g],i=h.xef001type||b.eventTypes.ENTRY_CHANGE;h.source=d;if(i===b.eventTypes.ENTRY_CHANGE){var j=h.xpid=h.xpid?h.xpid:d?d+"_"+h.xef001id:h.xef001id;delete h.xef001type;i={eventType:i,feed:c,xpid:j,entry:h};f.push(h);this.fireEvent(c,i)}else fjs.utils.Console.error("Incorrect item change type: "+i+" for Full sync")}this.db&&
(!fjs.fdp.transport.TransportFactory.useLocalStorageSyncronization()||(new fjs.api.TabsSynchronizer).isMaster)&&this.db.deleteByIndex(c,{source:d},function(){e.db.insertArray(c,f,null)})};fjs.fdp.SyncManager.prototype.keepSyncProcessItems=function(a,c,d){for(var e=[],f=[],g=[],h=this,i=0;i<a.length;i++){var j=a[i],k=j.xef001type||b.eventTypes.ENTRY_CHANGE,l=j.xpid=j.xpid?j.xpid:d?d+"_"+j.xef001id:j.xef001id;delete j.xef001type;j.source=d;j={eventType:k,feed:c,xpid:l,entry:j};if(this.db)switch(k){case b.eventTypes.ENTRY_CHANGE:e.push(j.entry);
g.push(j.entry.xpid);break;case b.eventTypes.ENTRY_KEEP:f.push(j.entry.xpid);break;default:fjs.utils.Console.error("Incorrect item change type: "+k+" for Keep sync")}this.fireEvent(c,j)}this.db&&(0<e.length&&(!fjs.fdp.transport.TransportFactory.useLocalStorageSyncronization()||(new fjs.api.TabsSynchronizer).isMaster))&&this.db.selectByIndex(c,{source:d},function(a){0>f.indexOf(a.xpid)&&0>g.indexOf(a.xpid)&&h.db.deleteByKey(c,a.xpid,null)},function(){h.db.insertArray(c,e,null)})};fjs.fdp.SyncManager.prototype.processFeedData=
function(a,c){this.fireEvent(a,{eventType:b.eventTypes.FEED_START,feed:a});for(var d in c)c.hasOwnProperty(d)&&"full"!=d&&this.processSourceData(a,d,c[d]);this.fireEvent(a,{eventType:b.eventTypes.FEED_COMPLETE,feed:a})};fjs.fdp.SyncManager.prototype.processSourceData=function(a,c,d){var e=d.xef001ver;d.filter&&this.saveHistoryVersions(a,c,d.filter,d.h_ver);var f=d.items,d=d.xef001type;this.fireEvent(a,{eventType:b.eventTypes.SOURCE_START,syncType:d,feed:a,sourceId:c});switch(d){case b.syncTypes.LAZY:this.lazySyncProcessItems(f,
a,c);break;case b.syncTypes.FULL:this.fullSyncProcessItems(f,a,c);break;case b.syncTypes.KEEP:this.keepSyncProcessItems(f,a,c);break;default:fjs.utils.Console.error("Unknown sync type: "+d)}this.fireEvent(a,{eventType:b.eventTypes.SOURCE_COMPLETE,feed:a,sourceId:c,syncType:d});this.saveVersions(a,c,e)};fjs.fdp.SyncManager.prototype.onSync=function(a){a=fjs.utils.JSON.parse(a);this.syncs.push(a);if(1==this.syncs.length){this.fireEvent(null,{eventType:b.eventTypes.SYNC_START});for(a=0;a<this.syncs.length;a++)for(var c in this.syncs[a])this.syncs[a].hasOwnProperty(c)&&
this.processFeedData(c,this.syncs[a][c]);this.fireEvent(null,{eventType:b.eventTypes.SYNC_COMPLETE});this.syncs=[]}else fjs.utils.Console.log("!!!!Double onSync!!",this.syncs[0],a)};fjs.fdp.SyncManager.prototype.sendAction=function(a,b,d){d.action=b;this.transport.send({type:"action",data:{feedName:a,actionName:b,parameters:d}})};fjs.fdp.SyncManager.prototype.onClientSync=function(a,b){fjs.fdp.transport.TransportFactory.useLocalStorageSyncronization()&&(new fjs.api.TabsSynchronizer).isMaster?fjs.fdp.transport.LocalStorageTransport.masterSend("message",
{type:"sync",data:a}):fjs.fdp.transport.TransportFactory.useLocalStorageSyncronization()&&!b&&fjs.fdp.transport.LocalStorageTransport.masterSend("clientSync",a);if(!fjs.fdp.transport.TransportFactory.useLocalStorageSyncronization()||(new fjs.api.TabsSynchronizer).isMaster)this.onSync(a)};fjs.fdp.SyncManager.prototype.getAuthTicket=function(){var a=this;this.state==b.states.READY&&this.db?this.db.clear(function(){a.fireEvent("authError",{type:"authError",message:"Auth ticket wrong or expired"})}):
a.fireEvent("authError",{type:"authError",message:"Auth ticket wrong or expired"})};fjs.fdp.SyncManager.prototype.addFeedListener=function(a,c,d){var e=this;0>this.feeds.indexOf(a)&&this.feeds.push(a);this.superClass.addEventListener.apply(this,arguments);this.status!=b.states.READY?d?0>this.suspendClientFeeds.indexOf(a)&&this.suspendClientFeeds.push(a):(0>this.suspendFeeds.indexOf(a)&&this.suspendFeeds.push(a),0>this.syncFeeds.indexOf(a)&&this.syncFeeds.push(a)):0>this.syncFeeds.indexOf(a)?(d||(this.syncFeeds.push(a),
0>this.versionsFeeds.indexOf(a)&&this.versionsFeeds.push(a),null!=this.versionsTimeoutId&&(clearTimeout(this.versionsTimeoutId),this.versionsTimeoutId=null),this.versionsTimeoutId=setTimeout(function(){e.startSync(e.versionsFeeds);e.versionsFeeds=[];e.versionsTimeoutId=null},100)),this.fireEvent(a,{eventType:b.eventTypes.SYNC_START,feed:a},c),this.getFeedData(a,function(d){d.eventType==b.eventTypes.FEED_COMPLETE&&e.fireEvent(a,{eventType:b.eventTypes.SYNC_COMPLETE,feed:a},c);c(d)})):0<=this.syncFeeds.indexOf(a)&&
this.states==b.READY&&(this.fireEvent(a,{eventType:b.eventTypes.SYNC_START,feed:a},c),this.getFeedData(a,function(d){d.eventType==b.eventTypes.FEED_COMPLETE&&e.fireEvent(a,{eventType:b.eventTypes.SYNC_COMPLETE,feed:a},c);c(d)}))};fjs.fdp.SyncManager.prototype.removeFeedListener=function(a,b,d){var e;(e=0<=this.feeds.indexOf(a))&&this.feeds.splice(e,1);this.superClass.removeEventListener.apply(this,arguments);d||(-1<(e=this.syncFeeds.indexOf(a))&&this.syncFeeds.splice(e,1),this.listeners[a]&&0==this.listeners[a].length&&
this.transport.send({type:"forget",data:{feedName:a}}))};fjs.fdp.SyncManager.prototype.getFeedData=function(a,c){var d=this;this.fireEvent(a,{eventType:b.eventTypes.FEED_START,syncType:"F",feed:a},c);this.db?this.db.selectAll(a,function(e){d.fireEvent(a,{eventType:b.eventTypes.ENTRY_CHANGE,feed:a,xpid:e.xpid,entry:e},c)},function(){d.fireEvent(a,{eventType:b.eventTypes.FEED_COMPLETE,feed:a},c)}):this.fireEvent(a,{eventType:b.eventTypes.FEED_COMPLETE,feed:a},c)};fjs.fdp.SyncManager.prototype.fireEvent=
function(a,b,d){if(d)d(b);else if(a)this.superClass.fireEvent.call(this,a,b);else for(var e in this.listeners)this.listeners.hasOwnProperty(e)&&-1<this.feeds.indexOf(e)&&this.superClass.fireEvent.call(this,e,b)};fjs.fdp.SyncManager.prototype.loadNext=function(a,b,d){var e=fjs.utils.JSON.stringify(b),b=this.historyversions[a];b||(b={},this.historyversions[a]=b);if(b[e])this.processHistoryVersions(a,e,d,b[e],function(){});else{var f=this,g=[];this.fillHistoryVersions(a,e,d,g,function(){f.processHistoryVersions(a,
e,d,g,function(){})})}};fjs.fdp.SyncManager.prototype.fillHistoryVersions=function(a,b,d,e,f){if(this.db){var g=this;this.db.selectByIndex("historyversions",{feedName:a,filter:b},function(a){e.push(a.source+":"+a.version)},function(){0==e.length?g.fillEmptyHistoryVersionsFromFeed(a,e,f):f()})}};fjs.fdp.SyncManager.prototype.fillEmptyHistoryVersionsFromFeed=function(a,b,d){this.db&&this.db.selectByIndex("versions",{feedName:a},function(a){b.push(a.source+":0")},d)};fjs.fdp.SyncManager.prototype.processHistoryVersions=
function(a,b,d,e,f){0==e.length?f&&f(!1):(this.historyversions[a][b]=e,b={"s.limit":d,"sh.filter":b,"sh.versions":e.join("@")},this.transport.send({type:"loadNext",data:{feedName:a,data:b}}),f&&f(!0))};fjs.fdp.SyncManager.prototype.saveHistoryVersions=function(a,b,d,e){if(this.db&&(!fjs.fdp.transport.TransportFactory.useLocalStorageSyncronization()||(new fjs.api.TabsSynchronizer).isMaster))if(this.db.insertOne("historyversions",{feedSourceFilter:a+"_"+b+"_filter",feedName:a,source:b,filter:d,version:e}),
b=this.historyversions[a])delete b[d],b||delete this.historyversions[a]};fjs.fdp.SyncManager.prototype.saveEmptyHistoryVersions=function(a,b){if(this.db&&(!fjs.fdp.transport.TransportFactory.useLocalStorageSyncronization()||(new fjs.api.TabsSynchronizer).isMaster))this.db.insertOne("historyversions",{feedName:a,filter:b,version:"-1"}),delete this.historyversions[a]};fjs.fdp.SyncManager.prototype.logout=function(){this.node=this.ticket=null;this.getAuthTicket();this.status=b.states.NOT_INITIALIZED};
fjs.fdp.SyncManager.prototype.SFLogin=function(a){var c=this;this.status==b.states.READY&&this.db?this.db.clear(function(){c.transport.send({type:"SFLogin",data:a})}):this.db?this.suspendLoginData=a:this.transport.send({type:"SFLogin",data:a})}})();namespace("fjs.fdp");
fjs.fdp.DataManager=function(b,a,c,d){if(this.constructor.__instance)return this.constructor.__instance;this.constructor.__instance=this;var e=this;fjs.EventsSource.call(this);this.ticket=b;this.node=a;this.config=c;this.sm=new fjs.fdp.SyncManager(this.config);var f=function(a){e.fireEvent(a.type,a)};this.sm.init(this.ticket,this.node,function(){d();e.sm.addEventListener("node",f);e.sm.addEventListener("ticket",f);e.sm.addEventListener("requestError",f);e.sm.addEventListener("authError",f);e.sm.addEventListener("networkProblem",
f);e.sm.addEventListener("connectionEstablished",f)});this.proxies={}};fjs.fdp.DataManager.extend(fjs.EventsSource);fjs.fdp.DataManager.prototype.addFeedListener=function(b,a){var c=this.proxies[b];c||(c=this.proxies[b]=this.createProxy(b));c.addListener(a)};fjs.fdp.DataManager.prototype.removeFeedListener=function(b,a){var c=this.proxies[b];c&&c.removeListener(a)};
fjs.fdp.DataManager.prototype.createProxy=function(b){switch(b){case "contacts":return new fjs.fdp.model.ProxyModel("contacts contactstatus calls calldetails fdpImage contactpermissions".split(" "),this.sm);case "locations":return new fjs.fdp.model.ProxyModel(["locations","location_status"],this.sm);case "mycalls":return new fjs.fdp.model.ProxyModel(["mycalls","mycalldetails"],this.sm);case "conferences":return new fjs.fdp.model.ProxyModel(["conferences","conferencestatus","conferencepermissions"],
this.sm);case "sortings":return new fjs.fdp.model.ClientFeedProxyModel(["sortings"],this.sm);case "mycallsclient":return new fjs.fdp.model.ClientFeedProxyModel(["mycalls","mycalldetails","mycallsclient"],this.sm);case "clientsettings":return new fjs.fdp.model.ClientFeedProxyModel(["clientsettings"],this.sm);default:return new fjs.fdp.model.ProxyModel([b],this.sm)}};fjs.fdp.DataManager.prototype.logout=function(){this.sm.logout()};
fjs.fdp.DataManager.prototype.sendAction=function(b,a,c){var d=this.proxies[b];d?d.sendAction(b,a,c):fjs.utils.Console.warn("DataManager: sendAction: no proxy model for feed: "+b)};fjs.fdp.DataManager.prototype.loadNext=function(b,a,c){this.proxies[b]||fjs.utils.Console.error("You don't listen this feed");this.sm.loadNext(b,a,c)};fjs.fdp.DataManager.prototype.fireEvent=function(b,a){var c=this.listeners[b],d;a.eventType=b;if(c)for(d=0;d<c.length;d++)c[d](a);if(c=this.listeners[""])for(d=0;d<c.length;d++)c[d](a)};
fjs.fdp.DataManager.prototype.SFLogin=function(b){this.sm.SFLogin(b)};
