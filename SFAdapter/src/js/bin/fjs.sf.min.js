'use strict';console.log("Build number: 12345678");var SFApi=function(){if(SFApi.__instance)return SFApi.__instance;SFApi.__instance=this};SFApi.PREFIX="Fon.";SFApi.FON_LOGIN_CLASS_NAME="FonLogin";SFApi.prototype.enableCalls=function(a){a?sforce.interaction.cti.enableClickToDial():sforce.interaction.cti.disableClickToDial()};SFApi.prototype.setPhoneApi=function(a,c){this.enableCalls(!0);sforce.interaction.cti.onClickToDial(c)};
SFApi.prototype.addCallLog=function(a,c,b,d,e,f,i,h){var g="Completed";null==c&&null==c&&(g="Not Started");var j="Subject="+encodeURIComponent(a)+"&CallType="+e+"&CallDurationInSeconds="+f+"&Status="+g+"&Type=Call&ActivityDate="+i;c&&(j+="&WhoId="+c);b&&(j+="&WhatId="+b);SFApi.prototype.getCalllogCommentField(function(a){var b="Description";a&&a.result&&(null!=a.result&&""!=a.result)&&(b=a.result);j+="&"+b+"="+encodeURIComponent(d);f&&i&&e?sforce.interaction.saveLog("Task",j,function(a){h(a)}):console.error("Wrong arguments for adding call log.")})};
SFApi.prototype.getPhoneInfo=function(a,c,b,d){console.log("!!!!!!!!!  getPhoneInfo");b&&sforce.interaction.searchAndScreenPop(a,"acc10="+a+"&con10="+a+"&lea8="+a,c,d);sforce.interaction.searchAndGetScreenPopUrl(a,"",c,d)};SFApi.prototype.openUser=function(a,c){sforce.interaction.screenPop("/"+a,!0,c)};SFApi.prototype.setSoftphoneHeight=function(a,c){sforce.interaction.cti.setSoftphoneHeight(a,c)};SFApi.prototype.setSoftphoneWidth=function(a,c){sforce.interaction.cti.setSoftphoneWidth(a,c)};
SFApi.prototype.getLoginInfo=function(a){console.log("!!!!!!!!!  getLoginInfo");sforce.interaction.runApex(SFApi.PREFIX+SFApi.FON_LOGIN_CLASS_NAME,"getLoginInfo",null,a)};SFApi.prototype.getCalllogCommentField=function(a){sforce.interaction.runApex(SFApi.PREFIX+SFApi.FON_LOGIN_CLASS_NAME,"getCalllogFieldName",null,a)};namespace("fjs.sf");
fjs.sf.SFSimpleProvider=function(){if(fjs.sf.SFSimpleProvider.__instance)return fjs.sf.SFSimpleProvider.__instance;this.api=new SFApi;fjs.sf.SFSimpleProvider.__instance=this};
fjs.sf.SFSimpleProvider.prototype.sendAction=function(a){switch(a.action){case "enableCalls":this.api.enableCalls(a.data.isReg,a.callback);break;case "addCallLog":this.api.addCallLog(a.data.subject,a.data.whoId,a.data.whatId,a.data.note,a.data.callType,a.data.duration,a.data.date,a.callback);break;case "getPhoneInfo":this.api.getPhoneInfo(a.data.phone,a.data.callType,a.data.isRinging,a.callback);break;case "getCalllogCommentField":this.api.getCalllogCommentField(a.callback);break;case "getLoginInfo":this.api.getLoginInfo(a.callback);
break;case "setSoftphoneHeight":this.api.setSoftphoneHeight(a.data.height,a.callback);break;case "setSoftphoneWidth":this.api.setSoftphoneWidth(a.data.width,a.callback);break;case "setPhoneApi":this.api.setPhoneApi(a.data.isPhoneReg,a.callback)}};namespace("fjs.sf");
fjs.sf.SFSharedWorkerProvider=function(){var a=this;this.worker=new SharedWorker("sf_shared_worker.js");this.worker.port.addEventListener("message",function(c){"ready"==c.data.eventType&&a.sendMessage({action:"init"});a.fireEvent(c.data.eventType,c.data)},!1);this.worker.port.addEventListener("error",function(a){console.error("Worker Error",a)});this.worker.port.start();this.sendMessage=function(a){this.worker.port.postMessage(a)}};fjs.sf.SFSharedWorkerProvider.check=function(){return!!self.SharedWorker};
namespace("fjs.sf");fjs.sf.SFApiProviderFactory=function(){if(fjs.sf.SFApiProviderFactory.__instance)return fjs.sf.SFApiProviderFactory.__instance;fjs.sf.SFApiProviderFactory.__instance=this;this.sfProvider=new fjs.sf.SFSimpleProvider};fjs.sf.SFApiProviderFactory.prototype.sendAction=function(a,c,b){this.sfProvider.sendAction(a,c,b)};var sfa_model=angular.module("SF_API",[]);sfa_model.service("SFApi",fjs.sf.SFApiProviderFactory);namespace("fjs.model");
fjs.model.FeedModel=function(a,c){fjs.EventsSource.call(this);this.feedName=a;this.items={};this.order=[];this.dataManager=c;this.listeners={start:[],push:[],"delete":[],complete:[]};this.init()};fjs.model.FeedModel.extend(fjs.EventsSource);fjs.model.FeedModel.EVENT_TYPE_START="start";fjs.model.FeedModel.EVENT_TYPE_PUSH="push";fjs.model.FeedModel.EVENT_TYPE_DELETE="delete";fjs.model.FeedModel.EVENT_TYPE_CHANGE="change";fjs.model.FeedModel.EVENT_TYPE_COMPLETE="complete";
fjs.model.FeedModel.prototype.getEntryByXpid=function(a){return this.items[a]};fjs.model.FeedModel.prototype.init=function(){var a=this;this.dataManager.addEventListener(this.feedName,function(c){a.onSyncStart();for(var b in c.changes)if(c.changes.hasOwnProperty(b)){var d=c.changes[b];if(fjs.model.FeedModel.EVENT_TYPE_CHANGE==d.type)a.onEntryChange(d);else if(fjs.model.FeedModel.EVENT_TYPE_DELETE==d.type)a.onEntryDeletion(d);else console.error("Unknown change type:",d.type)}a.onSyncComplete()})};
fjs.model.FeedModel.prototype.prepareEntry=function(){};fjs.model.FeedModel.prototype.onSyncStart=function(a){this.fireEvent(fjs.model.FeedModel.EVENT_TYPE_START,a)};fjs.model.FeedModel.prototype.onEntryDeletion=function(a){var c=this.order.indexOf(this.items[a.xpid]);-1<c&&this.order.splice(c,1);delete this.items[a.xpid];this.fireEvent(fjs.model.FeedModel.EVENT_TYPE_DELETE,a)};
fjs.model.FeedModel.prototype.onEntryChange=function(a){var c=this.items[a.xpid];c?c.fill(a.entry):(c=this.items[a.xpid]=new fjs.model.EntryModel(a.entry),this.order.push(c));this.prepareEntry(c);this.fireEvent(fjs.model.FeedModel.EVENT_TYPE_PUSH,c)};fjs.model.FeedModel.prototype.onSyncComplete=function(a){this.fireEvent(fjs.model.FeedModel.EVENT_TYPE_COMPLETE,a)};
fjs.model.FeedModel.prototype.addEventListener=function(a,c){fjs.EventsSource.prototype.addEventListener.call(this,a,c);if(a==fjs.model.FeedModel.EVENT_TYPE_PUSH)for(var b in this.items)this.items.hasOwnProperty(b)&&c({eventType:fjs.model.FeedModel.EVENT_TYPE_PUSH,xpid:b,entry:this.items[b]})};namespace("fjs.model");fjs.model.EntryModel=function(a){this.xpid=this.xef001iver=this.xef001id=null;this.fill(a)};
fjs.model.EntryModel.prototype.fill=function(a){if(a)for(var c in a)a.hasOwnProperty(c)&&(this[c]=a[c])};namespace("fjs.model");fjs.model.MeModel=function(a){fjs.model.FeedModel.call(this,fjs.model.MeModel.NAME,a);this.property2key={};this.propertyKey2Xpid={}};fjs.model.MeModel.extend(fjs.model.FeedModel);
fjs.model.MeModel.prototype.onEntryChange=function(a){if(a.entry)a.entry.propertyKey?(this.propertyKey2Xpid[a.xpid]=a.entry.propertyKey,this.property2key[a.entry.propertyKey]=a.entry.propertyValue):this.property2key[this.propertyKey2Xpid[a.xpid]]=a.entry.propertyValue,this.superClass.onEntryChange.call(this,a);else debugger};
fjs.model.MeModel.prototype.onEntryDeletion=function(a){var c=this.propertyKey2Xpid[a.xpid];delete this.propertyKey2Xpid[a.xpid];delete this.property2key[c];this.superClass.onEntryDeletion.call(this,a)};fjs.model.MeModel.prototype.getProperty=function(a){return this.property2key[a]};fjs.model.MeModel.NAME="me";namespace("fjs.model");fjs.model.MyCallsFeedModel=function(a){fjs.model.FeedModel.call(this,"mycallsclient",a);this.htCallIdToXpid={};this.listeners.changepid=[];this.changes={}};fjs.model.MyCallsFeedModel.extend(fjs.model.FeedModel);
fjs.model.MyCallsFeedModel.prototype.prepareEntry=function(a){this.htCallIdToXpid[a.htCallId]=a.xpid};fjs.model.MyCallsFeedModel.prototype.htCallIdByXpid=function(a){for(var c in this.htCallIdToXpid)if(this.htCallIdToXpid.hasOwnProperty(c)&&this.htCallIdToXpid[c]==a)return c};fjs.model.MyCallsFeedModel.prototype.onEntryDeletion=function(a){var c=this.htCallIdByXpid(a.xpid);this.changes[c]||(this.changes[c]={});this.changes[c].delete=a};
fjs.model.MyCallsFeedModel.prototype.onEntryChange=function(a){var c=this.items[a.xpid],c=c?c.htCallId:a.entry.htCallId;this.changes[c]||(this.changes[c]={});this.changes[c].push=a};
fjs.model.MyCallsFeedModel.prototype.onSyncComplete=function(a){console.log("!!!OnCallsSyncStart!!!");for(var c in this.changes)if(this.changes.hasOwnProperty(c)){var b=this.changes[c];if(b.push&&!b.delete){var d=b.push;(b=this.items[d.xpid])?b.fill(d.entry):(b=this.items[d.xpid]=new fjs.model.EntryModel(d.entry),this.order.push(b));this.prepareEntry(b);this.fireEvent("push",b);console.log("!!!!push ",d.xpid,d.entry)}else if(!b.push&&b.delete)d=b.delete,b=this.order.indexOf(this.items[d.xpid]),-1<
b&&this.order.splice(b,1),delete this.items[d.xpid],this.fireEvent("delete",d),console.log("!!!!delete ",d.xpid);else if(b.push&&b.delete){var d=b.delete,e=b.push,b=this.items[d.xpid];b.fill(e.entry);delete this.items[d.xpid];this.prepareEntry(b);this.items[e.xpid]=b;b.oldPid=d.xpid;e.eventType="changepid";this.fireEvent("changepid",b);console.log("!!!!changepid ","from:",b.oldPid,"to:",e.xpid)}}this.changes={};this.fireEvent("complete",a);console.log("!!!OnCallsSyncEnd!!!")};
fjs.model.MyCallsFeedModel.NAME="mycallsclient";namespace("fjs.model");
fjs.model.DataManager=function(a){fjs.EventsSource.call(this);this.feeds={};this.node=this.ticket=null;this.phoneMap={};this.state=-1;this.suspendFeeds=[];this.warningListeners={};this.sf=a;var c=new fjs.api.FDPProviderFactory,b=this;this.authErrorCount=0;this.MAX_AUTH_ERROR_COUNT=3;var d=function(a){var a=a&&a.result&&JSON.parse(a.result),c=a.number;if(c){var d={};d.id=a.objectId;d.type=a.object;b.phoneMap[c]=d;b.sendAction(fjs.model.MeModel.NAME,"callTo",{phoneNumber:c})}};this.checkDevice=function(){var b=
{action:"setPhoneApi",data:{}};b.data.isReg=!0;b.callback=d;a.sendAction(b)};this.checkDevice();this._getAuthInfo(function(a){a&&(b._authInfoChanged(a)||!b._getAccessInfo()?(fjs.utils.Cookies.remove(fjs.model.DataManager.AUTH_COOKIE_NAME),b.dataProvider=c.getProvider(null,null,function(){b.dataProvider.sendMessage({action:"SFLogin",data:a});b.state=1})):b.dataProvider=c.getProvider(b.ticket,b.node,function(){b.state=1;if(0<b.suspendFeeds.length){for(var a=0;a<b.suspendFeeds.length;a++)b.dataProvider.addSyncForFeed(b.suspendFeeds[a]);
b.suspendFeeds=[]}}),b.dataProvider.addEventListener(fjs.model.DataManager.EV_SYNC,function(a){a=a.data||a;b.fireEvent(a.feed,a)}),b.dataProvider.addEventListener(fjs.model.DataManager.EV_AUTH_ERROR,function(){if(b.authErrorCount<b.MAX_AUTH_ERROR_COUNT){b._getAuthInfo(function(a){b.dataProvider.sendMessage({action:"SFLogin",data:a})});b.authErrorCount++}else b.fireWarningEvent(fjs.model.DataManager.AUTHORIZATION_STATE,false)}),b.dataProvider.addEventListener(fjs.model.DataManager.EV_REQUEST_ERROR,
function(a){console.error(a)}),b.dataProvider.addEventListener(fjs.model.DataManager.EV_NETWORK_PROBLEM,function(a){console.error(a);b.fireWarningEvent(fjs.model.DataManager.CONNECTION_STATE,false)}),b.dataProvider.addEventListener(fjs.model.DataManager.EV_CONNECTION_ESTABLISHED,function(a){console.error(a);b.fireWarningEvent(fjs.model.DataManager.CONNECTION_STATE,true)}),b.dataProvider.addEventListener(fjs.model.DataManager.EV_NODE,function(a){fjs.utils.Cookies.set(fjs.model.DataManager.NODE_COOKIE_NAME,
b.node=a.data.nodeId)}),b.dataProvider.addEventListener(fjs.model.DataManager.EV_TICKET,function(a){fjs.utils.Cookies.set(fjs.model.DataManager.AUTH_COOKIE_NAME,b.ticket=a.data.ticket);b.fireWarningEvent(fjs.model.DataManager.AUTHORIZATION_STATE,true);if(b.suspendFeeds.length>0){for(a=0;a<b.suspendFeeds.length;a++)b.dataProvider.addSyncForFeed(b.suspendFeeds[a]);b.suspendFeeds=[]}}))})};fjs.model.DataManager.extend(fjs.EventsSource);fjs.model.DataManager.AUTHORIZATION_STATE="Authorization";
fjs.model.DataManager.CONNECTION_STATE="Connection";fjs.model.DataManager.EV_SYNC="sync";fjs.model.DataManager.EV_AUTH_ERROR="authError";fjs.model.DataManager.EV_REQUEST_ERROR="requestError";fjs.model.DataManager.EV_NETWORK_PROBLEM="networkProblem";fjs.model.DataManager.EV_CONNECTION_ESTABLISHED="connectionEstablished";fjs.model.DataManager.EV_TICKET="ticket";fjs.model.DataManager.EV_NODE="node";fjs.model.DataManager.AUTH_COOKIE_NAME="SF_Authorization";fjs.model.DataManager.NODE_COOKIE_NAME="SF_Node";
fjs.model.DataManager.CLIENT_ID_COOKIE_NAME="SF_Client_id";fjs.model.DataManager.SERVER_URL_COOKIE_NAME="SF_ServerUrl";fjs.model.DataManager.HUD_LOGIN_COOKIE_NAME="SF_Login";fjs.model.DataManager.HUD_EMAIL_COOKIE_NAME="SF_Email";
fjs.model.DataManager.prototype.getModel=function(a){if(!this.feeds[a])switch(a){case fjs.model.MeModel.NAME:this.feeds[a]=new fjs.model.MeModel(this);break;case "mycallsclient":this.feeds[a]=new fjs.model.MyCallsFeedModel(this);break;default:this.feeds[a]=new fjs.model.FeedModel(a,this)}return this.feeds[a]};fjs.model.DataManager.prototype.sendAction=function(a,c,b){this.dataProvider&&this.dataProvider.sendMessage({action:"fdp_action",data:{feedName:a,actionName:c,params:b}})};
fjs.model.DataManager.prototype._authInfoChanged=function(a){var c=!1;fjs.utils.Cookies.get(fjs.model.DataManager.HUD_LOGIN_COOKIE_NAME)!=a.hud&&(fjs.utils.Cookies.set(fjs.model.DataManager.HUD_LOGIN_COOKIE_NAME,a.hud),c=!0);fjs.utils.Cookies.get(fjs.model.DataManager.HUD_EMAIL_COOKIE_NAME)!=a.email&&(fjs.utils.Cookies.set(fjs.model.DataManager.HUD_EMAIL_COOKIE_NAME,a.email),c=!0);return c};
fjs.model.DataManager.prototype._getAccessInfo=function(){this.ticket=fjs.utils.Cookies.get(fjs.model.DataManager.AUTH_COOKIE_NAME);this.node=fjs.utils.Cookies.get(fjs.model.DataManager.NODE_COOKIE_NAME);return this.ticket};
fjs.model.DataManager.prototype._getAuthInfo=function(a){this.sf.sendAction({action:"getLoginInfo",callback:function(c){var b=null,d=null;c&&(c.error?(console.error("SF response error",c.error),a(null)):d=JSON.parse(c.result));d&&(b={login:d.admLogin,token:d.admPassword,email:d.email},d.hudLogin&&(b.hud=d.hudLogin),fjs.fdp.CONFIG.SERVER.serverURL=d.serverUrl);a(b)}})};
fjs.model.DataManager.prototype.addEventListener=function(a,c){if(!this.listeners[a]||0==this.listeners[a].length)1!=this.state&&0>this.suspendFeeds.indexOf(a)?this.suspendFeeds.push(a):this.dataProvider.addSyncForFeed(a);this.superClass.addEventListener.call(this,a,c)};fjs.model.DataManager.prototype.addWarningListener=function(a,c){if(this.warningListeners[a])this.warningListeners[a].push(c);else{var b=[];b.push(c);this.warningListeners[a]=b}};
fjs.model.DataManager.prototype.removeWarningListener=function(a,c){var b=this.warningListeners[a].indexOf(c);-1<b&&this.warningListeners[a].splice(b,1)};fjs.model.DataManager.prototype.fireWarningEvent=function(a,c){var b=this.warningListeners[a];if(b)for(var d=0;d<b.length;d++)b[d](c)};sfa_model=angular.module("SFA_model",["SF_API"]);sfa_model.service("DataManager",["SFApi",fjs.model.DataManager]);namespace("fjs.controllers");fjs.controllers.CommonController=function(){};
fjs.controllers.CommonController.prototype.safeApply=function(a,c){var b=a.$root.$$phase;"$apply"==b||"$digest"==b?c&&"function"===typeof c&&c():a.$apply(c)};fjs.controllers.CommonController.COMPLETE_LISTENER="complete";fjs.controllers.CommonController.PUSH_LISTENER="push";fjs.controllers.CommonController.DELETE_LISTENER="delete";namespace("fjs.controllers");
fjs.controllers.CallController=function(a,c,b,d,e,f){function i(){var c=new Date,f=c.getTime()-v.getDefault()+6E4*(new Date(1)).getTimezoneOffset(),e=f-a.call.created,f=f-a.call.holdStart;a.duration=d("date")(new Date(e),"HH:mm:ss ");a.call.duration=c.getTime()-(a.call.created+v.getDefault());a.onHold&&(a.holdDuration=d("date")(new Date(f),"HH:mm:ss "));p=b(i,fjs.controllers.CallController.CALL_DURATION_DELAY_IN_SEC)}function h(b){var c={},d=null,f=0;if(b&&b.result){b=JSON.parse(b.result);a.call.mycallsclient_callLog.what=
[];a.call.mycallsclient_callLog.who=[];for(var i in b)if(b.hasOwnProperty(i)&&"screenPopUrl"!=i){f++;var g=d=b[i];c[g.object]||(c[g.object]=[]);g._id=i;"Contact"==g.object||"Lead"==g.object?a.call.mycallsclient_callLog.who.push(g):("Case"==g.object&&(g.Name=g.CaseNumber),a.call.mycallsclient_callLog.what.push(g));c[g.object].push(g)}a.call.mycallsclient_callLog.fields=[];if(1==f)for(var h in d)d.hasOwnProperty(h)&&"object"!=h&&"_id"!=h&&a.call.mycallsclient_callLog.fields.push({title:h,value:d[h],
id:d._id});else for(h in c){f=c[h];f.sort(j);a.call.mycallsclient_callLog.fields.push({title:h+" ("+f.length+")",value:f[0][fjs.controllers.CallController.SORT_FIELD_NAME],id:f[0]._id});for(d=1;d<f.length;d++)a.call.mycallsclient_callLog.fields.push({title:"",value:f[d][fjs.controllers.CallController.SORT_FIELD_NAME],id:f[d]._id})}}s();e.sendAction("mycallsclient","push",{callLog:a.call.mycallsclient_callLog,xpid:a.call.xpid});x.safeApply(a)}function g(){if(y=a.call.phone){var c=a.call.phone.replace(/\(|\)|-/g,
"");10<c.length&&(c=c.slice(c.length-10,c.length));if(a.call.type!=fjs.controllers.CallController.SYSTEM_CALL_TYPE){var d={action:"getPhoneInfo",data:{}};d.data.phone=c;d.data.callType=a.call.incoming?"inbound":"outbound";d.data.isRinging=0==a.call.state;d.callback=h;f.sendAction(d)}else s(),e.sendAction("mycallsclient","push",{callLog:a.call.mycallsclient_callLog,xpid:a.call.xpid});k=b(g,fjs.controllers.CallController.CALL_GET_INFO_DELAY_IN_SEC)}}function j(a,b){if(a[fjs.controllers.CallController.SORT_FIELD_NAME]&&
a[fjs.controllers.CallController.SORT_FIELD_NAME]){var c=a[fjs.controllers.CallController.SORT_FIELD_NAME].toLowerCase(),d=b[fjs.controllers.CallController.SORT_FIELD_NAME].toLowerCase();if(c<d)return-1;if(c>d)return 1}return 0}function s(){if(e.phoneMap[a.call.phone]){var b=e.phoneMap[a.call.phone];if("Contact"==b.type)a.call.mycallsclient_callLog.whoId=b.id,l(0);else if("Lead"==b.type)a.call.mycallsclient_callLog.whoId=b.id;else if(a.call.mycallsclient_callLog.who){a.call.mycallsclient_callLog.whatId=
b.id;for(b=0;b<a.call.mycallsclient_callLog.who.length;b++)if("Contact"==a.call.mycallsclient_callLog.who[b].object){a.call.mycallsclient_callLog.whoId=a.call.mycallsclient_callLog.who[b]._id;break}}delete e.phoneMap[a.call.phone]}else if(!e.phoneMap[a.call.phone]&&a.call.mycallsclient_callLog&&!a.call.mycallsclient_callLog.whatId&&!a.call.mycallsclient_callLog.whoId)a.call.mycallsclient_callLog.who&&a.call.mycallsclient_callLog.who[0]?(a.call.mycallsclient_callLog.whoId=a.call.mycallsclient_callLog.who[0]._id,
o(0)||l(0)):t()||l(0);else if(a.call.mycallsclient_callLog&&a.call.mycallsclient_callLog.whoId&&a.who){for(var c=!1,b=0;b<a.call.mycallsclient_callLog.who.length;b++)if(a.call.mycallsclient_callLog.who[b]._id==a.call.mycallsclient_callLog.whoId){c=!0;break}c||(a.call.mycallsclient_callLog.who&&a.call.mycallsclient_callLog.who[0]?(a.call.mycallsclient_callLog.whoId=a.call.mycallsclient_callLog.who[0]._id,o(0)||l(a.call.mycallsclient_callLog.whatId)):t()||l(a.call.mycallsclient_callLog.whatId))}else if(a.call.mycallsclient_callLog&&
a.call.mycallsclient_callLog.whatId&&a.what){for(b=0;b<a.call.mycallsclient_callLog.what.length&&a.call.mycallsclient_callLog.what[b]._id!=a.mycallsclient_callLog.whatId;b++);c||l(0)}}function t(){if(u())for(var b=0;b<a.who.length;b++)if(a.call.mycallsclient_callLog.who[b]._id==a.call.mycallsclient_callLog.whoId)return o(b)}function u(){return null!=a.call.mycallsclient_callLog&&null!=a.call.mycallsclient_callLog.who&&null!=a.call.mycallsclient_callLog.whoId}function l(b){null==a.call.mycallsclient_callLog.whatId&&
(null!=a.call.mycallsclient_callLog.what&&null!=a.call.mycallsclient_callLog.what[b])&&(a.call.mycallsclient_callLog.whatId=a.call.mycallsclient_callLog.what[b]._id)}function o(b){return a.call.mycallsclient_callLog&&"Lead"==a.call.mycallsclient_callLog.who[b].object}function w(){a.call.mycallsclient_callLog.isOpened=!1;a.call.mycallsclient_callLog.triangle=fjs.controllers.CallController.CLOSED_TRIANGLE;e.sendAction("mycallsclient","push",{callLog:a.call.mycallsclient_callLog,xpid:a.call.xpid})}function q(){a.call.mycallsclient_callLog.isOpened=
!0;a.call.mycallsclient_callLog.triangle=fjs.controllers.CallController.OPENED_TRIANGLE;e.sendAction("mycallsclient","push",{callLog:a.call.mycallsclient_callLog,xpid:a.call.xpid})}function r(){a.transferDialogPath=null;a.isTransferDialogClass=""}fjs.controllers.CommonController(this);e.getModel("mycallsclient");var p=null,k=null,v=new fjs.utils.TimeSync,y=null,x=this,n=null;a.templatePath="templates/call_item.html";a.callLogPath="templates/call_log.html";a.transferDialogPath=null;a.onHold=a.call.state==
fjs.controllers.CallController.HOLD_CALL_TYPE;a.isRing=a.call.state==fjs.controllers.CallController.RING_CALL_TYPE;if(!a.call.mycallsclient_callLog){a.call.mycallsclient_callLog={};var c=a.call.mycallsclient_callLog,m;m=new Date;m=m.getFullYear()+"-"+(m.getMonth()+1)+"-"+m.getDate();c.date=m;a.call.mycallsclient_callLog.subject="Call";a.call.mycallsclient_callLog.xpid=a.call.xpid;a.call.mycallsclient_callLog.isOpened=!0;a.call.mycallsclient_callLog.note="";a.call.mycallsclient_callLog.callType=a.call.incoming?
"inbound":"outbound";a.call.mycallsclient_callLog.triangle=fjs.controllers.CallController.OPENED_TRIANGLE}(void 0==a.call.mycallsclient_isOpened&&a.isRing||a.call.type==fjs.controllers.CallController.CONFERENCE_CALL_TYPE&&a.call.state==fjs.controllers.CallController.TALCKING_CALL_TYPE)&&a.$emit("selectCall",a.call);i();a.whoChange=function(){if(u()){for(var b=0;b<a.call.mycallsclient_callLog.who.length;b++)if(a.call.mycallsclient_callLog.who[b]._id==a.call.mycallsclient_callLog.whoId){o(b)?a.call.mycallsclient_callLog.whatId=
null:l(0);break}e.sendAction("mycallsclient","push",{callLog:a.call.mycallsclient_callLog,xpid:a.call.xpid})}};a.whatChange=function(){e.sendAction("mycallsclient","push",{callLog:a.call.mycallsclient_callLog,xpid:a.call.xpid})};a.noteChange=function(){null!=n&&(clearTimeout(n),n=null);n=setTimeout(function(){e.sendAction("mycallsclient","push",{callLog:a.call.mycallsclient_callLog,xpid:a.call.xpid})},fjs.controllers.CallController.CALL_LOG_CHANGE_DELAY_IN_SEC)};a.$watch("call.state",function(){a.onHold=
a.call.state==fjs.controllers.CallController.HOLD_CALL_TYPE;if(!a.onHold){var b=(new Date(0)).getTime()+6E4*(new Date(0)).getTimezoneOffset();a.holdDuration=d("date")(b,"HH:mm:ss ")}a.isRing=a.call.state==fjs.controllers.CallController.RING_CALL_TYPE},!0);a.$watch("call.phone",function(){g()});a.showDetails=function(){a.$emit("toggleCall",a.call)};a.hold=function(){e.sendAction(fjs.model.MyCallsFeedModel.NAME,"transferToHold",{mycallId:a.call.xpid});return!1};a.accept=function(){e.sendAction(fjs.model.MyCallsFeedModel.NAME,
"answer",{mycallId:a.call.xpid});return!1};a.transfer=function(){a.transferDialogPath="templates/transfer_dialog.html";a.isTransferDialogClass="call-item-transfer-opened";a.callLogPath&&w()};a.end=function(){e.sendAction(fjs.model.MyCallsFeedModel.NAME,"hangup",{mycallId:a.call.xpid});return!1};a.unhold=function(){e.sendAction(fjs.model.MyCallsFeedModel.NAME,"transferFromHold",{mycallId:a.call.xpid});return!1};a.toggleCallLog=function(){a.call.mycallsclient_callLog.isOpened?w():(q(),r())};a.openSFLink=
function(a){var b={action:"openUser",data:{}};b.data.id=a;f.sendAction(b)};a.$on("closeDialog",function(){r();q()});a.$on("transfer",function(b,c){c&&""!=c&&e.sendAction(fjs.model.MyCallsFeedModel.NAME,"transferTo",{mycallId:a.call.xpid,toNumber:c});r();q()});a.$on("$destroy",function(){p&&b.cancel(p);k&&(b.cancel(k),k=null);if(a.call.mycallsclient_callLog&&a.call.type!=fjs.controllers.CallController.SYSTEM_CALL_TYPE){a.call.mycallsclient_callLog.subject=a.call.mycallsclient_callLog.note&&""!=a.call.mycallsclient_callLog.note?
"Call: "+a.call.mycallsclient_callLog.note.substr(0,240)+" ...":"Call";var c={action:"addCallLog",data:{}};c.data.subject=a.call.mycallsclient_callLog.subject;c.data.whoId=a.call.mycallsclient_callLog.whoId;c.data.whatId=a.call.mycallsclient_callLog.whatId;c.data.note=a.call.mycallsclient_callLog.note;c.data.callType=a.call.incoming?"inbound":"outbound";c.data.duration=Math.round(a.call.duration/1E3);c.data.date=a.call.mycallsclient_callLog.date;c.callback=function(a){console.error(a)};f.sendAction(c)}clearTimeout(n)});
a.$watch("call.mycallsclient_isOpened",function(){a.call.mycallsclient_isOpened?k||(k=b(g,fjs.controllers.CallController.CALL_GET_INFO_DELAY_IN_SEC)):k&&(b.cancel(k),k=null)})};fjs.controllers.CallController.extend(fjs.controllers.CommonController);fjs.controllers.CallController.CONFERENCE_CALL_TYPE=0;fjs.controllers.CallController.SYSTEM_CALL_TYPE=7;fjs.controllers.CallController.HOLD_CALL_TYPE=3;fjs.controllers.CallController.RING_CALL_TYPE=0;fjs.controllers.CallController.TALCKING_CALL_TYPE=2;
fjs.controllers.CallController.OPENED_TRIANGLE="&#9660;";fjs.controllers.CallController.CLOSED_TRIANGLE="&#9658;";fjs.controllers.CallController.SORT_FIELD_NAME="Name";fjs.controllers.CallController.CALL_GET_INFO_DELAY_IN_SEC=1E3;fjs.controllers.CallController.CALL_DURATION_DELAY_IN_SEC=1E3;fjs.controllers.CallController.CALL_LOG_CHANGE_DELAY_IN_SEC=1E3;namespace("fjs.controllers");
fjs.controllers.CallsListController=function(a,c){this.callsFeedModel=c.getModel("mycallsclient");var b=this;fjs.controllers.CommonController.call(this,a);a.calls=this.callsFeedModel.order;a.$on("toggleCall",function(a,b){b.mycallsclient_isOpened?d(b):e(b)});this.completeCallsListener=function(){b.safeApply(a)};this.callsFeedModel.addEventListener(fjs.controllers.CommonController.COMPLETE_LISTENER,this.completeCallsListener);a.$on("selectCall",function(a,b){e(b)});var d=function(a){if(a.mycallsclient_isOpened){var b=
{};a.mycallsclient_isOpened=b.isOpened=!1;b.xpid=a.xpid;if(b.xpid)c.sendAction("mycallsclient","push",b);else debugger}},e=function(b){if(!b.mycallsclient_isOpened){var e={};b.mycallsclient_isOpened=e.isOpened=!0;e.xpid=b.xpid;if(e.xpid)c.sendAction("mycallsclient","push",e);else debugger}b=b.xpid;for(e=0;e<a.calls.length;e++){var h=a.calls[e];h.xpid!=b&&h.mycallsclient_isOpened&&d(h)}}};fjs.controllers.CallsListController.extend(fjs.controllers.CommonController);
fjs.controllers.CallsListController.SELECTED_CALL_ID="selected_call_id";fjs.controllers.CallsListController.SELECTED_CALL_ID_MODE="selected_call_id_mode";namespace("fjs.controllers");
fjs.controllers.MainController=function(a,c,b){fjs.controllers.CommonController(this);var d=this;this.clientSettingsModel=c.getModel(fjs.controllers.MainController.CLIENT_SETTINGS_FEED_MODEL);this.clientSettingsModel.addEventListener(fjs.controllers.CommonController.PUSH_LISTENER,function(b){if(b.xpid=fjs.controllers.MainController.IS_WARNING_SHOWN)a.isWarningsShown=b.value?!0:!1,d.safeApply(a)});this.meModel=c.getModel(fjs.model.MeModel.NAME);this.SOFTPHONE_HEIGHT=this.SOFTPHONE_WIDTH=200;this.FRAME_RESIZE_NAME=
"resizeFrame";a.isConnected=!0;a.warningsTemplatePath="templates/warnings.html";a.isWarningsShown=!1;a.loggined=!0;a.connection=!0;a.phone=!0;a.isLocationRegistered=!0;var e=function(){null!=g&&(clearTimeout(g),g=null);g=setTimeout(function(){var a=i.clientHeight;if(a!=h){var c={action:"setSoftphoneHeight",data:{}};c.data.height=i.clientHeight;c.callback=function(){g=null};b.sendAction(c)}h=a},100)},f={action:"setSoftphoneHeight",data:{}};f.data.height=d.SOFTPHONE_HEIGHT;b.sendAction(f);f={action:"setSoftphoneWidth",
data:{}};f.data.height=d.SOFTPHONE_WIDTH;b.sendAction(f);var i=document.getElementById(d.FRAME_RESIZE_NAME),h=i.clientHeight,g=null;document.body.onresize=function(){e()};setTimeout(function(){frame.onresize=function(){e()}},200);a.showWarnings=function(){a.isWarningsShown=!0;d.safeApply(a);c.sendAction(fjs.controllers.MainController.CLIENT_SETTINGS_FEED_MODEL,"push",{xpid:fjs.controllers.MainController.IS_WARNING_SHOWN,value:a.isWarningsShown})};a.hideWarnings=function(){a.isWarningsShown=!1;d.safeApply(a);
c.sendAction(fjs.controllers.MainController.CLIENT_SETTINGS_FEED_MODEL,"push",{xpid:fjs.controllers.MainController.IS_WARNING_SHOWN,value:a.isWarningsShown})};a.toggleWarnings=function(){a.isWarningsShown?a.hideWarnings():a.showWarnings()};var j=function(){a.isWarningsButtonShown=!a.loggined||!a.connection||!a.isLocationRegistered;a.loggined&&(a.connection&&a.isLocationRegistered)&&(a.isWarningsShown=!1);d.safeApply(a)};this.meListener=function(){var b=d.meModel.getProperty("display_name");a.name=
b?"User: "+b:"";b=d.meModel.getProperty("primary_extension");a.extension=b?"Extension: x"+b:"";d.safeApply(a)};this.authorizationWarningListener=function(b){a.loggined=b;j();a.isConnected=a.connection&&a.loggined;d.safeApply(a)};this.connectionWarningListener=function(b){setTimeout(function(){a.connection=b;j();a.isConnected=a.connection&&a.loggined;d.safeApply(a)},1E3)};a.$on("onLocationStatus",function(b,c){a.isLocationRegistered=c;j();d.safeApply(a)});a.$on("$destroy",function(){d.meModel.removeEventListener(fjs.controllers.CommonController.COMPLETE_LISTENER,
d.meListener);c.removeWarningListener(fjs.controllers.CommonController.AUTHORIZATION_LISTENER,d.authorizationWarningListener);c.removeWarningListener(fjs.controllers.CommonController.CONNECTION_LISTENER,d.connectionWarningListener)});this.meModel.addEventListener(fjs.controllers.CommonController.COMPLETE_LISTENER,this.meListener);c.addWarningListener(fjs.controllers.MainController.AUTHORIZATION_LISTENER,this.authorizationWarningListener);c.addWarningListener(fjs.controllers.MainController.CONNECTION_LISTENER,
this.connectionWarningListener);j()};fjs.controllers.MainController.CONNECTION_LISTENER="Connection";fjs.controllers.MainController.AUTHORIZATION_LISTENER="Authorization";fjs.controllers.MainController.CLIENT_SETTINGS_FEED_MODEL="clientsettings";fjs.controllers.MainController.IS_WARNING_SHOWN="isWarningsShown";fjs.controllers.MainController.extend(fjs.controllers.CommonController);namespace("fjs.controllers");
fjs.controllers.NewCallController=function(a,c,b){a.phone="";var d=document.getElementById("plate");d.onclick=function(){a.$apply(function(){a.closeDialpad()})};a.actionCall=function(c){b.sendAction(fjs.model.MeModel.NAME,"callTo",{phoneNumber:c});a.phone="";a.closeDialpad()};a.showDialpad=function(){a.dialogPath?a.closeDialpad():(a.dialogPath="templates/dialpad.html",d.style.display="block",e())};a.closeDialpad=function(){a.dialogPath=null;d.style.display="none"};a.$on("onDilapadKey",function(b,
c){a.phone+=c;e()});var e=function(){document.getElementById("inputPhone").focus()}};namespace("fjs.controllers");fjs.controllers.TransferDialog=function(a){a.transfer_phone="";a.dialpadPath="templates/dialpad.html";a.$on("onDilapadKey",function(c,b){a.transfer_phone+=b;document.getElementById("inputTransfer").focus()});a.closeDialog=function(){a.$emit("closeDialog")};a.transfer=function(){a.$emit("transfer",a.transfer_phone)}};namespace("fjs.controllers");
fjs.controllers.WarningsController=function(a,c,b){fjs.controllers.CommonController(this);this.me=b.getModel(fjs.model.MeModel.NAME);this.locations=b.getModel("locations");var d=this;this.completeMeListener=function(){a.name=d.me.getProperty("display_name");a.fdp_version=d.me.getProperty("fdp_version");a.my_jid=d.me.getProperty("my_jid");a.extension=d.me.getProperty("primary_extension");a.locationId=d.me.getProperty("current_location");if(d.locations.items&&d.locations.items[a.locationId]){a.location=
d.locations.items[a.locationId].shortName;var b=d.locations.items[a.locationId];b&&e(b)}d.safeApply(a)};this.locationListener=function(){if(d.locations.items&&d.locations.items[a.locationId]){var b=d.locations.items[a.locationId];a.location=b.shortName;e(b);d.safeApply(a)}};this.me.addEventListener(fjs.controllers.CommonController.COMPLETE_LISTENER,this.completeMeListener);this.locations.addEventListener(fjs.controllers.CommonController.COMPLETE_LISTENER,this.locationListener);var e=function(b){b&&
b.locationType==fjs.controllers.WarningsController.CARRIER_TYPE?(a.locationState=fjs.controllers.WarningsController.REGISTERED,a.$emit(fjs.controllers.WarningsController.ON_LOCATION_STATUS,!0)):"r"==b.location_status_deviceStatus?(a.locationState=fjs.controllers.WarningsController.REGISTERED,a.$emit(fjs.controllers.WarningsController.ON_LOCATION_STATUS,!0)):(a.locationState=fjs.controllers.WarningsController.UNREGISTERED,a.$emit(fjs.controllers.WarningsController.ON_LOCATION_STATUS,!1))};a.sendFeedback=
function(){var c;c="Jid: "+a.my_jid;c+="; Name: "+a.name;c+="; Extension: "+a.extension;c+="; License: "+a.license;c+="; FDP version: "+a.fdp_version;c=a.msg&&0!=a.msg.length?c+("; Message: "+a.msg+"."):c+";";var d={};d.description=c;d.date=(new Date).getTime();d.email="";d.taskId="-1_-1";b.sendAction(fjs.model.MeModel.NAME,"feedback",d);a.close()};a.close=function(){a.hideWarnings()};a.$on("$destroy",function(){d.me.removeEventListener(fjs.controllers.CommonController.PUSH_LISTENER,d.pushMeListener);
d.locations.removeEventListener(fjs.controllers.CommonController.COMPLETE_LISTENER,d.locationListener)})};fjs.controllers.WarningsController.extend(fjs.controllers.CommonController);fjs.controllers.WarningsController.REGISTERED="Registered";fjs.controllers.WarningsController.UNREGISTERED="Unregistered";fjs.controllers.WarningsController.CARRIER_TYPE="m";fjs.controllers.WarningsController.ON_LOCATION_STATUS="onLocationStatus";namespace("fjs.controllers");
fjs.controllers.DialpadController=function(a){a.clickDialpad=function(c){a.$emit("onDilapadKey",c)}};"use strict";var ng_app=angular.module("SFAdapter",["SFA_model","SF_API"]);ng_app.controller("NewCallController",["$scope","$element","DataManager",fjs.controllers.NewCallController]);ng_app.controller("CallsListController",["$scope","DataManager",fjs.controllers.CallsListController]);ng_app.controller("CallController",["$scope","$element","$timeout","$filter","DataManager","SFApi",fjs.controllers.CallController]);
ng_app.controller("DialpadController",["$scope",fjs.controllers.DialpadController]);ng_app.controller("TransferDialog",["$scope",fjs.controllers.TransferDialog]);ng_app.controller("WarningsController",["$scope","$element","DataManager",fjs.controllers.WarningsController]);ng_app.controller("MainController",["$scope","DataManager","SFApi",fjs.controllers.MainController]);
