'use strict';fjs.utils.Console.log("Build number: 1234567893");var SFApi=function(){if(SFApi.__instance)return SFApi.__instance;SFApi.__instance=this};SFApi.PREFIX="Fon.";SFApi.FON_LOGIN_CLASS_NAME="FonLogin";SFApi.prototype.enableCalls=function(a){a?sforce.interaction.cti.enableClickToDial():sforce.interaction.cti.disableClickToDial()};SFApi.prototype.setPhoneApi=function(a,b){this.enableCalls(!0);sforce.interaction.cti.onClickToDial(b)};
SFApi.prototype.addCallLog=function(a,b,d,c,g,h,k,i){var j="Completed";null==b&&null==b&&(j="Not Started");var e="Subject="+encodeURIComponent(a)+"&CallType="+g+"&CallDurationInSeconds="+h+"&Status="+j+"&Type=Call&ActivityDate="+k;b&&(e+="&WhoId="+b);d&&(e+="&WhatId="+d);SFApi.prototype.getCalllogCommentField(function(a){var b="Description";a&&a.result&&(null!=a.result&&""!=a.result)&&(b=a.result);e+="&"+b+"="+encodeURIComponent(c);h&&k&&g?sforce.interaction.saveLog("Task",e,function(a){i(a)}):fjs.utils.Console.error("Wrong arguments for adding call log.")})};
SFApi.prototype.getPhoneInfo=function(a,b,d,c){d&&sforce.interaction.searchAndScreenPop(a,"acc10="+a+"&con10="+a+"&lea8="+a,b,c);sforce.interaction.searchAndGetScreenPopUrl(a,"",b,c)};SFApi.prototype.openUser=function(a,b){sforce.interaction.screenPop("/"+a,!0,b)};SFApi.prototype.setSoftphoneHeight=function(a,b){sforce.interaction.cti.setSoftphoneHeight(a,b)};SFApi.prototype.setSoftphoneWidth=function(a,b){sforce.interaction.cti.setSoftphoneWidth(a,b)};
SFApi.prototype.getLoginInfo=function(a){sforce.interaction.runApex(SFApi.PREFIX+SFApi.FON_LOGIN_CLASS_NAME,"getLoginInfo",null,a)};SFApi.prototype.getCalllogCommentField=function(a){sforce.interaction.runApex(SFApi.PREFIX+SFApi.FON_LOGIN_CLASS_NAME,"getCalllogFieldName",null,a)};namespace("fjs.sf");
fjs.sf.SFSimpleProvider=function(){if(!fjs.sf.SFSimpleProvider.__instance){var a=new fjs.api.TabsSynchronizer,b=this;this.isMaster=a.isMaster;a.addEventListener("master_changed",function(){b.isMaster=a.isMaster});this.api=new SFApi;fjs.sf.SFSimpleProvider.__instance=this}return fjs.sf.SFSimpleProvider.__instance};
fjs.sf.SFSimpleProvider.prototype.sendAction=function(a){if(this.isMaster)switch(a.action){case "enableCalls":this.api.enableCalls(a.data.isReg,a.callback);break;case "addCallLog":this.api.addCallLog(a.data.subject,a.data.whoId,a.data.whatId,a.data.note,a.data.callType,a.data.duration,a.data.date,a.callback);break;case "getPhoneInfo":this.api.getPhoneInfo(a.data.phone,a.data.callType,a.data.isRinging,a.callback);break;case "getCalllogCommentField":this.api.getCalllogCommentField(a.callback)}switch(a.action){case "getLoginInfo":this.api.getLoginInfo(a.callback);
break;case "setSoftphoneHeight":this.api.setSoftphoneHeight(a.data.height,a.callback);break;case "setSoftphoneWidth":this.api.setSoftphoneWidth(a.data.width,a.callback);break;case "setPhoneApi":this.api.setPhoneApi(a.data.isPhoneReg,a.callback);break;case "openUser":this.api.openUser(a.data.id,a.callback)}};fjs.sf.SFSimpleProvider.check=function(){return!0};namespace("fjs.sf");
fjs.sf.SFSharedWorkerProvider=function(){if(!fjs.sf.SFSharedWorkerProvider.__instance){var a=this;this.callbacks={};this.worker=new SharedWorker("js/salesforce_api/sf_shared_worker.js");this.worker.port.addEventListener("message",function(b){fjs.utils.Console.log(b);"ready"==b.data.eventType?a.sendAction({action:"init"}):(a.callbacks.get(b.id)(b.data),delete a.callbacks[b.id])},!1);this.worker.port.addEventListener("error",function(a){fjs.utils.Console.error("Worker Error",a)});this.worker.port.start();
this.worker.port.postMessage("ping'");this.sendAction=function(b){if(b){var d=fjs.utils.GUID.create();a.callbacks[d]=b.callback;b.id=d;b.callback=null}a.worker.port.postMessage(b)};fjs.sf.SFSharedWorkerProvider.__instance=this}return fjs.sf.SFSharedWorkerProvider.__instance};fjs.sf.SFSharedWorkerProvider.check=function(){return!!self.SharedWorker};namespace("fjs.sf");fjs.sf.SFApiProviderFactory=function(){this._providers={sharedWorker:fjs.sf.SFSharedWorkerProvider,simple:fjs.sf.SFSimpleProvider}};
fjs.sf.SFApiProviderFactory.prototype.getProvider=function(){return new fjs.sf.SFSimpleProvider};var sfa_model=angular.module("SF_API",[]);sfa_model.service("SFApi",fjs.sf.SFApiProviderFactory);namespace("fjs.model");fjs.model.FeedModel=function(a,b){fjs.EventsSource.call(this);this.feedName=a;this.items={};this.order=[];this.dataManager=b;this.listeners={start:[],push:[],"delete":[],complete:[]};this.init()};fjs.model.FeedModel.extend(fjs.EventsSource);fjs.model.FeedModel.EVENT_TYPE_START="start";
fjs.model.FeedModel.EVENT_TYPE_PUSH="push";fjs.model.FeedModel.EVENT_TYPE_DELETE="delete";fjs.model.FeedModel.EVENT_TYPE_CHANGE="change";fjs.model.FeedModel.EVENT_TYPE_COMPLETE="complete";fjs.model.FeedModel.prototype.getEntryByXpid=function(a){return this.items[a]};
fjs.model.FeedModel.prototype.init=function(){var a=this;this.dataManager.addEventListener(this.feedName,function(b){a.onSyncStart();for(var d in b.changes)if(b.changes.hasOwnProperty(d)){var c=b.changes[d];if(fjs.model.FeedModel.EVENT_TYPE_CHANGE==c.type)a.onEntryChange(c);else if(fjs.model.FeedModel.EVENT_TYPE_DELETE==c.type)a.onEntryDeletion(c);else fjs.utils.Console.error("Unknown change type:",c.type)}a.onSyncComplete()})};fjs.model.FeedModel.prototype.prepareEntry=function(){};
fjs.model.FeedModel.prototype.onSyncStart=function(a){this.fireEvent(fjs.model.FeedModel.EVENT_TYPE_START,a)};fjs.model.FeedModel.prototype.onEntryDeletion=function(a){var b=this.order.indexOf(this.items[a.xpid]);-1<b&&this.order.splice(b,1);delete this.items[a.xpid];this.fireEvent(fjs.model.FeedModel.EVENT_TYPE_DELETE,a)};
fjs.model.FeedModel.prototype.onEntryChange=function(a){var b=this.items[a.xpid];b?b.fill(a.entry):(b=this.items[a.xpid]=new fjs.model.EntryModel(a.entry),this.order.push(b));this.prepareEntry(b);this.fireEvent(fjs.model.FeedModel.EVENT_TYPE_PUSH,b)};fjs.model.FeedModel.prototype.onSyncComplete=function(a){this.fireEvent(fjs.model.FeedModel.EVENT_TYPE_COMPLETE,a)};
fjs.model.FeedModel.prototype.addEventListener=function(a,b){fjs.EventsSource.prototype.addEventListener.call(this,a,b);if(a==fjs.model.FeedModel.EVENT_TYPE_PUSH)for(var d in this.items)this.items.hasOwnProperty(d)&&b({eventType:fjs.model.FeedModel.EVENT_TYPE_PUSH,xpid:d,entry:this.items[d]})};namespace("fjs.model");fjs.model.EntryModel=function(a){this.xpid=this.xef001iver=this.xef001id=null;this.fill(a)};
fjs.model.EntryModel.prototype.fill=function(a){if(a)for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b])};namespace("fjs.model");fjs.model.MeModel=function(a){fjs.model.FeedModel.call(this,fjs.model.MeModel.NAME,a);this.property2key={};this.propertyKey2Xpid={}};fjs.model.MeModel.extend(fjs.model.FeedModel);
fjs.model.MeModel.prototype.onEntryChange=function(a){if(a.entry)a.entry.propertyKey?(this.propertyKey2Xpid[a.xpid]=a.entry.propertyKey,this.property2key[a.entry.propertyKey]=a.entry.propertyValue):this.property2key[this.propertyKey2Xpid[a.xpid]]=a.entry.propertyValue,this.superClass.onEntryChange.call(this,a);else debugger};
fjs.model.MeModel.prototype.onEntryDeletion=function(a){var b=this.propertyKey2Xpid[a.xpid];delete this.propertyKey2Xpid[a.xpid];delete this.property2key[b];this.superClass.onEntryDeletion.call(this,a)};fjs.model.MeModel.prototype.getProperty=function(a){return this.property2key[a]};fjs.model.MeModel.NAME="me";namespace("fjs.model");
fjs.model.MyCallsFeedModel=function(a){fjs.model.FeedModel.call(this,"mycallsclient",a);this.htCallIdToXpid={};this.listeners.changepid=[];this.changes={};this.clientSettingsModel=this.dataManager.getModel("clientsettings")};fjs.model.MyCallsFeedModel.extend(fjs.model.FeedModel);fjs.model.MyCallsFeedModel.prototype.prepareEntry=function(a){this.htCallIdToXpid[a.htCallId]=a.xpid};
fjs.model.MyCallsFeedModel.prototype.htCallIdByXpid=function(a){for(var b in this.htCallIdToXpid)if(this.htCallIdToXpid.hasOwnProperty(b)&&this.htCallIdToXpid[b]==a)return b};fjs.model.MyCallsFeedModel.prototype.onEntryDeletion=function(a){var b=this.htCallIdByXpid(a.xpid);this.changes[b]||(this.changes[b]={});this.changes[b].delete=a};
fjs.model.MyCallsFeedModel.prototype.onEntryChange=function(a){var b=this.items[a.xpid],b=b?b.htCallId:a.entry.htCallId;this.changes[b]||(this.changes[b]={});this.changes[b].push=a};
fjs.model.MyCallsFeedModel.prototype.onSyncComplete=function(a){for(var b in this.changes)if(this.changes.hasOwnProperty(b)){var d=this.changes[b];if(d.push&&!d.delete){var c=d.push;(d=this.items[c.xpid])?d.fill(c.entry):(d=this.items[c.xpid]=new fjs.model.MyCallEntryModel(c.entry),this.order.push(d));this.prepareEntry(d);this.fireEvent("push",d);(!this.clientSettingsModel.items.openedCall||null!=this.clientSettingsModel.items.openedCall.value&&!this.items[this.clientSettingsModel.items.openedCall.value])&&
(2==d.state||0==d.state)&&this.dataManager.sendAction("clientsettings","push",{xpid:"openedCall",value:d.xpid});fjs.utils.Console.log("!!!!push ",c.xpid,c.entry)}else if(!d.push&&d.delete)c=d.delete,d=this.order.indexOf(this.items[c.xpid]),-1<d&&this.order.splice(d,1),delete this.items[c.xpid],this.fireEvent("delete",c),fjs.utils.Console.log("!!!!delete ",c.xpid);else if(d.push&&d.delete){var c=d.delete,g=d.push,d=this.items[c.xpid];d.fill(g.entry);delete this.items[c.xpid];this.prepareEntry(d);this.items[g.xpid]=
d;d.oldPid=c.xpid;g.eventType="changepid";this.fireEvent("changepid",d);fjs.utils.Console.log("!!!!changepid ","from:",d.oldPid,"to:",g.xpid)}}this.changes={};this.fireEvent("complete",a);fjs.utils.Console.log("!!!OnCallsSyncEnd!!!")};fjs.model.MyCallsFeedModel.NAME="mycallsclient";namespace("fjs.model");
fjs.model.MyCallEntryModel=function(a){this._who=[];this._what=[];var b=new Date;this.mycallsclient_callLog={date:b.getFullYear()+"-"+(b.getMonth()+1)+"-"+b.getDate(),subject:"Call",xpid:this.xpid,note:"",callType:this.incoming?"inbound":"outbound",isOpened:!0,tranferOpened:!1,whatId:null,whoId:null,what:{},who:{}};fjs.model.EntryModel.call(this,a)};fjs.model.MyCallEntryModel.extend(fjs.model.EntryModel);fjs.model.MyCallEntryModel.HOLD_CALL_TYPE=3;fjs.model.MyCallEntryModel.RING_CALL_TYPE=0;
fjs.model.MyCallEntryModel.prototype.onHold=function(){return this.state==fjs.model.MyCallEntryModel.HOLD_CALL_TYPE};fjs.model.MyCallEntryModel.prototype.isRing=function(){return this.state==fjs.model.MyCallEntryModel.RING_CALL_TYPE};fjs.model.MyCallEntryModel.prototype.hasWhos=function(){for(var a in this.mycallsclient_callLog.who)if(this.mycallsclient_callLog.who[a])return!0;return!1};
fjs.model.MyCallEntryModel.prototype.hasWhats=function(){for(var a in this.mycallsclient_callLog.what)if(this.mycallsclient_callLog.what[a])return!0;return!1};fjs.model.MyCallEntryModel.prototype.callLogItemUpdate=function(){};fjs.model.MyCallEntryModel.prototype.findCallLogTargetById=function(a,b){var d;if(d="Contact"==a||"Lead"==a?this.mycallsclient_callLog.who[a]:this.mycallsclient_callLog.what[a])for(var c=0;c<d.length;c++)if(d[c]._id==b)return d[c]};
fjs.model.MyCallEntryModel.prototype.fillCallLogData=function(a,b){var d=this._who.length,c=this._what.length,g=this.mycallsclient_callLog.whatId,h=this.mycallsclient_callLog.whoId,k=!1;this._who=[];this._what=[];var i=b.items.phoneMap&&b.items.phoneMap.phones||{};if(a&&a.result){var j=fjs.utils.JSON.parse(a.result),e;for(e in j)if(j.hasOwnProperty(e)&&"screenPopUrl"!=e){var f=j[e];f._id=e;if("Contact"==f.object||"Lead"==f.object){this.mycallsclient_callLog.who[f.object]||(this.mycallsclient_callLog.who[f.object]=
[]);var l=this.findCallLogTargetById(f.object,e);l?l.Name!=f.Name&&(l.Name=f.Name,k=!0):this.mycallsclient_callLog.who[f.object].push(f);this._who.push(f)}else"Case"==f.object&&(f.Name=f.CaseNumber),this.mycallsclient_callLog.what[f.object]||(this.mycallsclient_callLog.what[f.object]=[]),(l=this.findCallLogTargetById(f.object,e))?l.Name!=f.Name&&(l.Name=f.Name,k=!0):this.mycallsclient_callLog.what[f.object].push(f),this._what.push(f)}}i[this.phone]?(i=i[this.phone],"Contact"==i.type?(this.mycallsclient_callLog.whoId=
i.id,this.mycallsclient_callLog.whatId=this._what[0]&&this._what[0]._id||null):"Lead"==i.type?(this.mycallsclient_callLog.whoId=i.id,this.mycallsclient_callLog.whatId=null):(this.mycallsclient_callLog.whatId=i.id,this.mycallsclient_callLog.who.Contact&&(this.mycallsclient_callLog.whoId=this.mycallsclient_callLog.who.Contact[0]._id||null)),b.deletePhone(this.phone)):!i[this.phone]&&(!this.mycallsclient_callLog.whatId&&!this.mycallsclient_callLog.whoId)&&(this.mycallsclient_callLog.who.Contact?(this.mycallsclient_callLog.whoId=
this.mycallsclient_callLog.who.Contact[0]._id,this.mycallsclient_callLog.whatId=this._what[0]&&this._what[0]._id||null):this.mycallsclient_callLog.who.Lead?(this.mycallsclient_callLog.whoId=this.mycallsclient_callLog.who.Lead[0]._id,this.mycallsclient_callLog.whatId=null):(this.mycallsclient_callLog.whoId=null,this.mycallsclient_callLog.whatId=this._what[0]&&this._what[0]._id||null));return k||this._what.length!=c||this._who.length!=d||g!=this.mycallsclient_callLog.whatId||h!=this.mycallsclient_callLog.whoId};
namespace("fjs.model");fjs.model.ClientSettingsFeedModel=function(a){fjs.model.FeedModel.call(this,"clientsettings",a)};fjs.model.ClientSettingsFeedModel.extend(fjs.model.FeedModel);fjs.model.ClientSettingsFeedModel.prototype.savePhone=function(a,b){if(this.items.phoneMap)this.items.phoneMap.phones[a]=b,this.dataManager.sendAction("clientsettings","push",this.items.phoneMap);else{var d={xpid:"phoneMap",phones:{}};d.phones[a]=b;this.dataManager.sendAction("clientsettings","push",d)}};
fjs.model.ClientSettingsFeedModel.prototype.deletePhone=function(a){this.items.phoneMap&&(delete this.items.phoneMap.phones[a],this.dataManager.sendAction("clientsettings","push",this.items.phoneMap))};namespace("fjs.model");
fjs.model.DataManager=function(a){fjs.EventsSource.call(this);this.feeds={};this.node=this.ticket=null;this.phoneMap={};this.state=-1;this.suspendFeeds=[];this.warningListeners={};this.sf=a.getProvider();var b=this,d=new fjs.api.FDPProviderFactory;this.authErrorCount=0;this.MAX_AUTH_ERROR_COUNT=3;var c=function(a){var a=a&&a.result&&JSON.parse(a.result),d=a.number;if(d){var c={};c.id=a.objectId;c.type=a.object;b.getModel("clientsettings").savePhone(d,c);b.sendAction(fjs.model.MeModel.NAME,"callTo",
{phoneNumber:d})}};this.checkDevice=function(){var a={action:"setPhoneApi",data:{}};a.data.isReg=!0;a.callback=c;b.sf.sendAction(a)};this.checkDevice();this._getAuthInfo(function(a){a&&(b._authInfoChanged(a)||!b._getAccessInfo()?(fjs.utils.Cookies.remove(fjs.model.DataManager.AUTH_COOKIE_NAME),b.dataProvider=d.getProvider(null,null,function(){b.dataProvider.sendMessage({action:"SFLogin",data:a});b.state=1})):b.dataProvider=d.getProvider(b.ticket,b.node,function(){b.state=1;if(0<b.suspendFeeds.length){for(var a=
0;a<b.suspendFeeds.length;a++)b.dataProvider.addSyncForFeed(b.suspendFeeds[a]);b.suspendFeeds=[]}}),b.dataProvider.addEventListener(fjs.model.DataManager.EV_SYNC,function(a){a=a.data||a;b.fireEvent(a.feed,a)}),b.dataProvider.addEventListener(fjs.model.DataManager.EV_AUTH_ERROR,function(){if(b.authErrorCount<b.MAX_AUTH_ERROR_COUNT){b._getAuthInfo(function(a){b.dataProvider.sendMessage({action:"SFLogin",data:a})});b.authErrorCount++}else b.fireWarningEvent(fjs.model.DataManager.AUTHORIZATION_STATE,
false)}),b.dataProvider.addEventListener(fjs.model.DataManager.EV_REQUEST_ERROR,function(a){fjs.utils.Console.error(a)}),b.dataProvider.addEventListener(fjs.model.DataManager.EV_NETWORK_PROBLEM,function(a){fjs.utils.Console.error(a);b.fireWarningEvent(fjs.model.DataManager.CONNECTION_STATE,false)}),b.dataProvider.addEventListener(fjs.model.DataManager.EV_CONNECTION_ESTABLISHED,function(a){fjs.utils.Console.info(a);b.fireWarningEvent(fjs.model.DataManager.CONNECTION_STATE,true)}),b.dataProvider.addEventListener(fjs.model.DataManager.EV_NODE,
function(a){fjs.utils.Cookies.set(fjs.model.DataManager.NODE_COOKIE_NAME,b.node=a.data.nodeId)}),b.dataProvider.addEventListener(fjs.model.DataManager.EV_TICKET,function(a){fjs.utils.Cookies.set(fjs.model.DataManager.AUTH_COOKIE_NAME,b.ticket=a.data.ticket);b.fireWarningEvent(fjs.model.DataManager.AUTHORIZATION_STATE,true);if(b.suspendFeeds.length>0){for(a=0;a<b.suspendFeeds.length;a++)b.dataProvider.addSyncForFeed(b.suspendFeeds[a]);b.suspendFeeds=[]}}))})};fjs.model.DataManager.extend(fjs.EventsSource);
fjs.model.DataManager.AUTHORIZATION_STATE="Authorization";fjs.model.DataManager.CONNECTION_STATE="Connection";fjs.model.DataManager.EV_SYNC="sync";fjs.model.DataManager.EV_AUTH_ERROR="authError";fjs.model.DataManager.EV_REQUEST_ERROR="requestError";fjs.model.DataManager.EV_NETWORK_PROBLEM="networkProblem";fjs.model.DataManager.EV_CONNECTION_ESTABLISHED="connectionEstablished";fjs.model.DataManager.EV_TICKET="ticket";fjs.model.DataManager.EV_NODE="node";fjs.model.DataManager.AUTH_COOKIE_NAME="SF_Authorization";
fjs.model.DataManager.NODE_COOKIE_NAME="SF_Node";fjs.model.DataManager.CLIENT_ID_COOKIE_NAME="SF_Client_id";fjs.model.DataManager.SERVER_URL_COOKIE_NAME="SF_ServerUrl";fjs.model.DataManager.HUD_LOGIN_COOKIE_NAME="SF_Login";fjs.model.DataManager.HUD_EMAIL_COOKIE_NAME="SF_Email";
fjs.model.DataManager.prototype.getModel=function(a){if(!this.feeds[a])switch(a){case fjs.model.MeModel.NAME:this.feeds[a]=new fjs.model.MeModel(this);break;case "mycallsclient":this.feeds[a]=new fjs.model.MyCallsFeedModel(this);break;case "clientsettings":this.feeds[a]=new fjs.model.ClientSettingsFeedModel(this);break;default:this.feeds[a]=new fjs.model.FeedModel(a,this)}return this.feeds[a]};
fjs.model.DataManager.prototype.sendAction=function(a,b,d){this.dataProvider&&this.dataProvider.sendMessage({action:"fdp_action",data:{feedName:a,actionName:b,params:d}})};
fjs.model.DataManager.prototype._authInfoChanged=function(a){var b=!1;fjs.utils.Cookies.get(fjs.model.DataManager.HUD_LOGIN_COOKIE_NAME)!=a.hud&&(fjs.utils.Cookies.set(fjs.model.DataManager.HUD_LOGIN_COOKIE_NAME,a.hud),b=!0);fjs.utils.Cookies.get(fjs.model.DataManager.HUD_EMAIL_COOKIE_NAME)!=a.email&&(fjs.utils.Cookies.set(fjs.model.DataManager.HUD_EMAIL_COOKIE_NAME,a.email),b=!0);return b};
fjs.model.DataManager.prototype._getAccessInfo=function(){this.ticket=fjs.utils.Cookies.get(fjs.model.DataManager.AUTH_COOKIE_NAME);this.node=fjs.utils.Cookies.get(fjs.model.DataManager.NODE_COOKIE_NAME);return this.ticket};
fjs.model.DataManager.prototype._getAuthInfo=function(a){this.sf.sendAction({action:"getLoginInfo",callback:function(b){var d=null,c=null;b&&(b.error?(fjs.utils.Console.error("SF response error",b.error),a(null)):c=JSON.parse(b.result));c&&(d={login:c.admLogin,token:c.admPassword,email:c.email},c.hudLogin&&(d.hud=c.hudLogin),fjs.fdp.CONFIG.SERVER.serverURL=c.serverUrl);a(d)}})};
fjs.model.DataManager.prototype.addEventListener=function(a,b){if(!this.listeners[a]||0==this.listeners[a].length)1!=this.state&&0>this.suspendFeeds.indexOf(a)?this.suspendFeeds.push(a):this.dataProvider.addSyncForFeed(a);this.superClass.addEventListener.call(this,a,b)};fjs.model.DataManager.prototype.addWarningListener=function(a,b){if(this.warningListeners[a])this.warningListeners[a].push(b);else{var d=[];d.push(b);this.warningListeners[a]=d}};
fjs.model.DataManager.prototype.removeWarningListener=function(a,b){var d=this.warningListeners[a].indexOf(b);-1<d&&this.warningListeners[a].splice(d,1)};fjs.model.DataManager.prototype.fireWarningEvent=function(a,b){var d=this.warningListeners[a];if(d)for(var c=0;c<d.length;c++)d[c](b)};sfa_model=angular.module("SFA_model",["SF_API"]);sfa_model.service("DataManager",["SFApi",fjs.model.DataManager]);namespace("fjs.controllers");fjs.controllers.CommonController=function(){};
fjs.controllers.CommonController.prototype.safeApply=function(a,b){var d=a.$root.$$phase;"$apply"==d||"$digest"==d?b&&"function"===typeof b&&b():a.$apply(b)};fjs.controllers.CommonController.COMPLETE_LISTENER="complete";fjs.controllers.CommonController.PUSH_LISTENER="push";fjs.controllers.CommonController.DELETE_LISTENER="delete";namespace("fjs.controllers");
fjs.controllers.CallController=function(a,b,d,c,g,h,k){function i(b){p&&a.call.fillCallLogData(b,v)&&(e(),p.safeApply(a))}function j(){l();if(w=a.call.phone){var b=a.call.phone.replace(/\(|\)|-/g,"");10<b.length&&(b=b.slice(b.length-10,b.length));if(a.call.type!=fjs.controllers.CallController.SYSTEM_CALL_TYPE){var c={action:"getPhoneInfo",data:{}};c.data.phone=b;c.data.callType=a.call.incoming?"inbound":"outbound";c.data.isRinging=0==a.call.state;c.callback=i;q.sendAction(c)}m=d(j,fjs.controllers.CallController.CALL_GET_INFO_DELAY_IN_SEC)}}
function e(){null!=n&&(clearTimeout(n),n=null);n=setTimeout(function(){h.sendAction("mycallsclient","push",{callLog:a.call.mycallsclient_callLog,xpid:a.call.xpid})},fjs.controllers.CallController.CALL_LOG_CHANGE_DELAY_IN_SEC)}function f(){a.call.mycallsclient_callLog.isOpened=!0;a.call.mycallsclient_callLog.tranferOpened=!1;e()}function l(){m&&(d.cancel(m),m=null)}fjs.controllers.CommonController(this);h.getModel("mycallsclient");var o=null,m=null,s=new fjs.utils.TimeSync,w=null,p=this,n=null,q=k.getProvider(),
v=h.getModel("clientsettings");a.getTriangle=function(){return g.trustAsHtml(a.call.mycallsclient_callLog.isOpened?fjs.controllers.CallController.OPENED_TRIANGLE:fjs.controllers.CallController.CLOSED_TRIANGLE)};var r=new fjs.api.TabsSynchronizer,t=function(){r.isMaster?m=d(j,fjs.controllers.CallController.CALL_GET_INFO_DELAY_IN_SEC):l()};r.addEventListener("master_changed",t);var u=function(){var b=(new Date).getTime()-s.getDefault()+6E4*(new Date(1)).getTimezoneOffset(),h=b-a.call.created,b=b-a.call.holdStart;
a.call.duration=c("date")(new Date(h),"HH:mm:ss ");a.call.onHold()&&(a.call.holdDuration=c("date")(new Date(b),"HH:mm:ss "));o=d(u,fjs.controllers.CallController.CALL_DURATION_DELAY_IN_SEC)};u();a.showWhatSelect=function(){return a.call.hasWhats()&&!a.call.findCallLogTargetById("Lead",a.call.mycallsclient_callLog.whoId)};a.getWhatArray=function(){var b=[],c;for(c in a.call.mycallsclient_callLog.what)b=b.concat(a.call.mycallsclient_callLog.what[c]);return b};a.getWhoArray=function(){var b=[],c;for(c in a.call.mycallsclient_callLog.who)b=
b.concat(a.call.mycallsclient_callLog.who[c]);return b};a.whoChange=function(){if(a.call.mycallsclient_callLog.who.Lead&&-1<a.call.mycallsclient_callLog.who.Lead.indexOf(a.call.mycallsclient_callLog.whoId))a.call.mycallsclient_callLog.pervWhatId=a.call.mycallsclient_callLog.whatId,a.call.mycallsclient_callLog.whatId=null;else if(null==a.call.mycallsclient_callLog.whatId)if(a.call.mycallsclient_callLog.pervWhatId)a.call.mycallsclient_callLog.whatId=a.call.mycallsclient_callLog.pervWhatId;else for(var b in a.call.mycallsclient_callLog.what)a.call.mycallsclient_callLog.what[b]&&
(a.call.mycallsclient_callLog.whatId=a.call.mycallsclient_callLog.what[b][0]);e()};a.whatChange=function(){e()};a.noteChange=function(){e()};a.$watch("call.phone",function(){j()});a.hold=function(){h.sendAction(fjs.model.MyCallsFeedModel.NAME,"transferToHold",{mycallId:a.call.xpid});return!1};a.accept=function(){h.sendAction(fjs.model.MyCallsFeedModel.NAME,"answer",{mycallId:a.call.xpid});return!1};a.transfer=function(){a.call.mycallsclient_callLog.tranferOpened=!0;a.call.mycallsclient_callLog.isOpened=
!1;e()};a.end=function(){h.sendAction(fjs.model.MyCallsFeedModel.NAME,"hangup",{mycallId:a.call.xpid});return!1};a.unhold=function(){h.sendAction(fjs.model.MyCallsFeedModel.NAME,"transferFromHold",{mycallId:a.call.xpid});return!1};a.toggleCallLog=function(){a.call.mycallsclient_callLog.isOpened?(a.call.mycallsclient_callLog.isOpened=!1,e()):f()};a.openSFLink=function(a){var b={action:"openUser",data:{}};b.data.id=a;q.sendAction(b)};a.closeTransferDialog=function(){f()};a.$on("transfer",function(b,
c){c&&h.sendAction(fjs.model.MyCallsFeedModel.NAME,"transferTo",{mycallId:a.call.xpid,toNumber:c});f()});a.$on("$destroy",function(){o&&d.cancel(o);r.removeEventListener("master_changed",t);l();if(a.call.mycallsclient_callLog&&a.call.type!=fjs.controllers.CallController.SYSTEM_CALL_TYPE){a.call.mycallsclient_callLog.subject=a.call.mycallsclient_callLog.note&&""!=a.call.mycallsclient_callLog.note?"Call: "+a.call.mycallsclient_callLog.note.substr(0,240)+" ...":"Call";var b={action:"addCallLog",data:{}};
b.data.subject=a.call.mycallsclient_callLog.subject;b.data.whoId=a.call.mycallsclient_callLog.whoId;b.data.whatId=a.call.mycallsclient_callLog.whatId;b.data.note=a.call.mycallsclient_callLog.note;b.data.callType=a.call.incoming?"inbound":"outbound";b.data.duration=Math.round(((new Date).getTime()-(a.call.created+s.getDefault()))/1E3);b.data.date=a.call.mycallsclient_callLog.date;b.callback=function(a){fjs.utils.Console.error(a)};q.sendAction(b)}p=null;clearTimeout(n)})};fjs.controllers.CallController.extend(fjs.controllers.CommonController);
fjs.controllers.CallController.CONFERENCE_CALL_TYPE=0;fjs.controllers.CallController.SYSTEM_CALL_TYPE=7;fjs.controllers.CallController.HOLD_CALL_TYPE=3;fjs.controllers.CallController.RING_CALL_TYPE=0;fjs.controllers.CallController.TALCKING_CALL_TYPE=2;fjs.controllers.CallController.OPENED_TRIANGLE="&#9660;";fjs.controllers.CallController.CLOSED_TRIANGLE="&#9658;";fjs.controllers.CallController.SORT_FIELD_NAME="Name";fjs.controllers.CallController.CALL_GET_INFO_DELAY_IN_SEC=3E3;
fjs.controllers.CallController.CALL_DURATION_DELAY_IN_SEC=1E3;fjs.controllers.CallController.CALL_LOG_CHANGE_DELAY_IN_SEC=500;namespace("fjs.controllers");
fjs.controllers.CallsListController=function(a,b){this.callsFeedModel=b.getModel("mycallsclient");var d=this;fjs.controllers.CommonController.call(this,a);var c=b.getModel("clientsettings");a.calls=this.callsFeedModel.order;a.selectedCallId=c.items.openedCall&&c.items.openedCall.value;a.selectCall=function(c){a.selectedCallId=a.selectedCallId!=c?c:null;b.sendAction("clientsettings","push",{xpid:"openedCall",value:a.selectedCallId})};this.clientSettingsListener=function(){a.selectedCallId=c.items.openedCall&&
c.items.openedCall.value;d.safeApply(a)};this.completeCallsListener=function(){d.safeApply(a)};c.addEventListener(fjs.controllers.CommonController.COMPLETE_LISTENER,this.clientSettingsListener);this.callsFeedModel.addEventListener(fjs.controllers.CommonController.COMPLETE_LISTENER,this.completeCallsListener)};fjs.controllers.CallsListController.extend(fjs.controllers.CommonController);fjs.controllers.CallsListController.SELECTED_CALL_ID="selected_call_id";
fjs.controllers.CallsListController.SELECTED_CALL_ID_MODE="selected_call_id_mode";namespace("fjs.controllers");
fjs.controllers.MainController=function(a,b,d){fjs.controllers.CommonController(this);var c=this,g=d.getProvider();this.clientSettingsModel=b.getModel(fjs.controllers.MainController.CLIENT_SETTINGS_FEED_MODEL);this.clientSettingsModel.addEventListener(fjs.controllers.CommonController.COMPLETE_LISTENER,function(){c.clientSettingsModel.items[fjs.controllers.MainController.IS_WARNING_SHOWN]&&(a.isWarningsShown=c.clientSettingsModel.items[fjs.controllers.MainController.IS_WARNING_SHOWN].value,c.safeApply(a))});
this.meModel=b.getModel(fjs.model.MeModel.NAME);this.SOFTPHONE_HEIGHT=this.SOFTPHONE_WIDTH=200;this.FRAME_RESIZE_NAME="resizeFrame";a.isConnected=!0;a.warningsTemplatePath="templates/warnings.html";a.isWarningsShown=!1;a.loggined=!0;a.connection=!0;a.phone=!0;a.isLocationRegistered=!0;var h=function(){null!=j&&(clearTimeout(j),j=null);j=setTimeout(function(){var a=k.clientHeight;if(a!=i){var b={action:"setSoftphoneHeight",data:{}};b.data.height=k.clientHeight;b.callback=function(){j=null};g.sendAction(b)}i=
a},100)},d={action:"setSoftphoneHeight",data:{}};d.data.height=c.SOFTPHONE_HEIGHT;g.sendAction(d);d={action:"setSoftphoneWidth",data:{}};d.data.height=c.SOFTPHONE_WIDTH;g.sendAction(d);var k=document.getElementById(c.FRAME_RESIZE_NAME),i=k.clientHeight,j=null;document.body.onresize=function(){h()};setTimeout(function(){frame.onresize=function(){h()}},200);a.showWarnings=function(){a.isWarningsShown=!0;c.safeApply(a);b.sendAction(fjs.controllers.MainController.CLIENT_SETTINGS_FEED_MODEL,"push",{xpid:fjs.controllers.MainController.IS_WARNING_SHOWN,
value:a.isWarningsShown})};a.hideWarnings=function(){a.isWarningsShown=!1;c.safeApply(a);b.sendAction(fjs.controllers.MainController.CLIENT_SETTINGS_FEED_MODEL,"push",{xpid:fjs.controllers.MainController.IS_WARNING_SHOWN,value:a.isWarningsShown})};a.toggleWarnings=function(){a.isWarningsShown?a.hideWarnings():a.showWarnings()};var e=function(){a.isWarningsButtonShown=!a.loggined||!a.connection||!a.isLocationRegistered;a.loggined&&(a.connection&&a.isLocationRegistered)&&(a.isWarningsShown=!1);c.safeApply(a)};
this.meListener=function(){var b=c.meModel.getProperty("display_name");a.name=b?"User: "+b:"";b=c.meModel.getProperty("primary_extension");a.extension=b?"Extension: x"+b:"";c.safeApply(a)};this.authorizationWarningListener=function(b){a.loggined=b;e();a.isConnected=a.connection&&a.loggined;c.safeApply(a)};this.connectionWarningListener=function(b){setTimeout(function(){a.connection=b;e();a.isConnected=a.connection&&a.loggined;c.safeApply(a)},1E3)};a.$on("onLocationStatus",function(b,d){a.isLocationRegistered=
d;e();c.safeApply(a)});a.$on("$destroy",function(){c.meModel.removeEventListener(fjs.controllers.CommonController.COMPLETE_LISTENER,c.meListener);b.removeWarningListener(fjs.controllers.CommonController.AUTHORIZATION_LISTENER,c.authorizationWarningListener);b.removeWarningListener(fjs.controllers.CommonController.CONNECTION_LISTENER,c.connectionWarningListener)});this.meModel.addEventListener(fjs.controllers.CommonController.COMPLETE_LISTENER,this.meListener);b.addWarningListener(fjs.controllers.MainController.AUTHORIZATION_LISTENER,
this.authorizationWarningListener);b.addWarningListener(fjs.controllers.MainController.CONNECTION_LISTENER,this.connectionWarningListener);e()};fjs.controllers.MainController.CONNECTION_LISTENER="Connection";fjs.controllers.MainController.AUTHORIZATION_LISTENER="Authorization";fjs.controllers.MainController.CLIENT_SETTINGS_FEED_MODEL="clientsettings";fjs.controllers.MainController.IS_WARNING_SHOWN="isWarningsShown";fjs.controllers.MainController.extend(fjs.controllers.CommonController);namespace("fjs.controllers");
fjs.controllers.NewCallController=function(a,b,d){a.phone="";var c=document.getElementById("plate");c.onclick=function(){a.$apply(function(){a.closeDialpad()})};a.actionCall=function(b){d.sendAction(fjs.model.MeModel.NAME,"callTo",{phoneNumber:b});a.phone="";a.closeDialpad()};a.showDialpad=function(){a.dialogPath?a.closeDialpad():(a.dialogPath="templates/dialpad.html",c.style.display="block",g())};a.closeDialpad=function(){a.dialogPath=null;c.style.display="none"};a.$on("onDilapadKey",function(b,
c){a.phone+=c;g()});var g=function(){document.getElementById("inputPhone").focus()}};namespace("fjs.controllers");fjs.controllers.TransferDialog=function(a){a.transfer_phone="";a.dialpadPath="templates/dialpad.html";a.$on("onDilapadKey",function(b,d){a.transfer_phone+=d;document.getElementById("inputTransfer").focus()});a.transfer=function(){a.$emit("transfer",a.transfer_phone)}};namespace("fjs.controllers");
fjs.controllers.WarningsController=function(a,b,d){fjs.controllers.CommonController(this);this.me=d.getModel(fjs.model.MeModel.NAME);this.locations=d.getModel("locations");var c=this;this.completeMeListener=function(){a.name=c.me.getProperty("display_name");a.fdp_version=c.me.getProperty("fdp_version");a.my_jid=c.me.getProperty("my_jid");a.extension=c.me.getProperty("primary_extension");a.locationId=c.me.getProperty("current_location");if(c.locations.items&&c.locations.items[a.locationId]){a.location=
c.locations.items[a.locationId].shortName;var b=c.locations.items[a.locationId];b&&g(b)}c.safeApply(a)};this.locationListener=function(){if(c.locations.items&&c.locations.items[a.locationId]){var b=c.locations.items[a.locationId];a.location=b.shortName;g(b);c.safeApply(a)}};this.me.addEventListener(fjs.controllers.CommonController.COMPLETE_LISTENER,this.completeMeListener);this.locations.addEventListener(fjs.controllers.CommonController.COMPLETE_LISTENER,this.locationListener);var g=function(b){b&&
b.locationType==fjs.controllers.WarningsController.CARRIER_TYPE?(a.locationState=fjs.controllers.WarningsController.REGISTERED,a.$emit(fjs.controllers.WarningsController.ON_LOCATION_STATUS,!0)):"r"==b.location_status_deviceStatus?(a.locationState=fjs.controllers.WarningsController.REGISTERED,a.$emit(fjs.controllers.WarningsController.ON_LOCATION_STATUS,!0)):(a.locationState=fjs.controllers.WarningsController.UNREGISTERED,a.$emit(fjs.controllers.WarningsController.ON_LOCATION_STATUS,!1))};a.sendFeedback=
function(){var b;b="Jid: "+a.my_jid;b+="; Name: "+a.name;b+="; Extension: "+a.extension;b+="; License: "+a.license;b+="; FDP version: "+a.fdp_version;b=a.msg&&0!=a.msg.length?b+("; Message: "+a.msg+"."):b+";";var c={};c.description=b;c.date=(new Date).getTime();c.email="";c.taskId="-1_-1";d.sendAction(fjs.model.MeModel.NAME,"feedback",c);a.close()};a.close=function(){a.hideWarnings()};a.$on("$destroy",function(){c.me.removeEventListener(fjs.controllers.CommonController.PUSH_LISTENER,c.pushMeListener);
c.locations.removeEventListener(fjs.controllers.CommonController.COMPLETE_LISTENER,c.locationListener)})};fjs.controllers.WarningsController.extend(fjs.controllers.CommonController);fjs.controllers.WarningsController.REGISTERED="Registered";fjs.controllers.WarningsController.UNREGISTERED="Unregistered";fjs.controllers.WarningsController.CARRIER_TYPE="m";fjs.controllers.WarningsController.ON_LOCATION_STATUS="onLocationStatus";namespace("fjs.controllers");
fjs.controllers.DialpadController=function(a){a.clickDialpad=function(b){a.$emit("onDilapadKey",b)}};"use strict";var ng_app=angular.module("SFAdapter",["SFA_model","SF_API"]);ng_app.controller("NewCallController",["$scope","$element","DataManager",fjs.controllers.NewCallController]);ng_app.controller("CallsListController",["$scope","DataManager",fjs.controllers.CallsListController]);ng_app.controller("CallController",["$scope","$element","$timeout","$filter","$sce","DataManager","SFApi",fjs.controllers.CallController]);
ng_app.controller("DialpadController",["$scope",fjs.controllers.DialpadController]);ng_app.controller("TransferDialog",["$scope",fjs.controllers.TransferDialog]);ng_app.controller("WarningsController",["$scope","$element","DataManager",fjs.controllers.WarningsController]);ng_app.controller("MainController",["$scope","DataManager","SFApi",fjs.controllers.MainController]);
