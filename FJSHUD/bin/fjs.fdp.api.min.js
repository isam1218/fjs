'use strict';namespace("fjs.api");fjs.api.DataProviderBase=function(a,b,d){fjs.EventsSource.call(this);this.ticket=a;this.node=b;this.config=d;this.listeners={}};fjs.api.DataProviderBase.extend(fjs.EventsSource);fjs.api.DataProviderBase.check=function(){return!1};fjs.api.DataProviderBase.prototype.sendMessage=function(){};fjs.api.DataProviderBase.prototype.addSyncForFeed=function(a){this.sendMessage({action:"registerSync",data:{feedName:a}})};
fjs.api.DataProviderBase.prototype.removeSyncForFeed=function(a){this.sendMessage({action:"unregisterSync",data:{feedName:a}})};fjs.api.DataProviderBase.prototype.logout=function(){this.sendMessage({action:"logout",data:null})};fjs.api.DataProviderBase.prototype.sendAction=function(a,b,d){this.sendMessage({action:"fdp_action",data:{actionName:b,params:d}})};namespace("fjs.api");
fjs.api.SimpleClientDataProvider=function(a,b,d){var c=this;fjs.api.DataProviderBase.call(this,a,b);a=document.createElement("script");this.dataManager=null;this.onSync=function(a){c.fireEvent("sync",a)};a.onload=function(){c.dataManager=new fjs.fdp.DataManager(c.ticket,c.node,fjs.fdp.CONFIG,function(){});c.dataManager.addEventListener("",function(a){c.fireEvent(a.eventType,a)});d()};document.head.appendChild(a);a.src="js/lib/fjs.fdp.min.js"};fjs.api.SimpleClientDataProvider.extend(fjs.api.DataProviderBase);
fjs.api.SimpleClientDataProvider.check=function(){return!0};
fjs.api.SimpleClientDataProvider.prototype.sendMessage=function(a){switch(a.action){case "registerSync":this.dataManager.addFeedListener(a.data.feedName,this.onSync);break;case "unregisterSync":this.dataManager.removeFeedListener(a.data.feedName,this.onSync);break;case "logout":this.dataManager.logout();break;case "fdp_action":this.dataManager.sendAction(a.data.feedName,a.data.actionName,a.data.params);break;case "SFLogin":this.dataManager.SFLogin(a.data);break;default:fjs.utils.Console.error("Unknown action: "+
a.action)}};namespace("fjs.api");
fjs.api.WebWorkerDataProvider=function(a,b,d){var c=this;fjs.api.DataProviderBase.call(this,a,b);this.worker=new Worker("js/lib/fdp_worker.js");this.worker.addEventListener("message",function(a){"ready"==a.data.eventType&&(c.sendMessage({action:"init",data:{ticket:c.ticket,node:c.node,config:fjs.fdp.CONFIG}}),d());c.fireEvent(a.data.eventType,a.data)},!1);this.worker.addEventListener("error",function(a){fjs.utils.Console.error("Worker Error",a)});this.sendMessage=function(a){c.worker.postMessage(a)}};
fjs.api.WebWorkerDataProvider.extend(fjs.api.DataProviderBase);fjs.api.WebWorkerDataProvider.check=function(){return!!window.Worker};fjs.api.WebWorkerDataProvider.prototype.sendMessage=function(a){this.worker.postMessage(a)};namespace("fjs.api");
fjs.api.SharedWorkerDataProvider=function(a,b,d){var c=this;fjs.api.DataProviderBase.call(this,a,b);this.worker=new SharedWorker("js/lib/fdp_shared_worker_min.js");this.worker.port.addEventListener("message",function(a){"ready"==a.data.eventType&&(c.sendMessage({action:"init",data:{ticket:c.ticket,node:c.node,config:fjs.fdp.CONFIG}}),d());c.fireEvent(a.data.eventType,a.data)},!1);this.worker.port.addEventListener("error",function(a){fjs.utils.Console.error("Worker Error",a)});this.worker.port.start();
this.sendMessage=function(a){this.worker.port.postMessage(a)}};fjs.api.SharedWorkerDataProvider.extend(fjs.api.DataProviderBase);fjs.api.SharedWorkerDataProvider.check=function(){return!!self.SharedWorker};namespace("fjs.api");fjs.api.FDPProviderFactory=function(){this._providers={sharedWorker:fjs.api.SharedWorkerDataProvider,webWorker:fjs.api.WebWorkerDataProvider,simple:fjs.api.SimpleClientDataProvider}};
fjs.api.FDPProviderFactory.prototype.getProvider=function(a,b,d){for(var c=0;c<fjs.fdp.CONFIG.providers.length;c++){var e=this._providers[fjs.fdp.CONFIG.providers[c]];if(e.check())return new e(a,b,d)}};
(function(){namespace("fjs.api");fjs.api.TabsSynchronizer=function(){if(this.constructor.__instance)return this.constructor.__instance;this.constructor.__instance=this;var a=this;fjs.EventsSource.call(this);this.CHANGE_TAB_TIMEOUT=2E3;this.MASTER_ACTIVITY_TIMEOUT=500;this.TABS_SYNCRONIZE_KEY="tabs_sync_maintab";this.tabId=Date.now()+"_"+fjs.utils.GUID.create();this.timeoutId=null;this.isMaster=this._checkMaster();this.lastValues={};this.lastMasterValue=null;this.cookiesSynchronizationRuned=this.hasChange=
!1;this._runMaster=function(){a._masterIteration()};this.db=null;window.onfocus=function(){console.log("focus")};window.onblur=function(){console.log("blur")};this._masterIteration=function(){fjs.utils.Browser.isIE11()?fjs.utils.Cookies.set(a.TABS_SYNCRONIZE_KEY,a.tabId+"|"+Date.now()):localStorage.setItem(a.TABS_SYNCRONIZE_KEY,a.tabId+"|"+Date.now());a.isMaster||a.fireEvent("master_changed",a.isMaster=!0);clearTimeout(a.timeoutId);a.timeoutId=setTimeout(a._masterIteration,a.MASTER_ACTIVITY_TIMEOUT)};
this.onStorage=function(b){b.key==a.TABS_SYNCRONIZE_KEY&&(b=b.newValue.split("|"),b[0]!=a.tabId&&a.tabId>b[0]&&(a.isMaster&&a.fireEvent("master_changed",a.isMaster=!1),clearTimeout(a.timeoutId),a.timeoutId=setTimeout(a._runMaster,a.CHANGE_TAB_TIMEOUT)))};fjs.utils.Browser.isIE11()?setInterval(function(){var b=fjs.utils.Cookies.get(a.TABS_SYNCRONIZE_KEY);b&&b!=a.lastMasterValue&&(a.onStorage({key:a.TABS_SYNCRONIZE_KEY,newValue:b}),a.lastMasterValue=b)},0):self.addEventListener("storage",a.onStorage,
!1);this._checkMaster()?this._runMaster():this.timeoutId=setTimeout(this._runMaster,this.CHANGE_TAB_TIMEOUT)};fjs.api.TabsSynchronizer.extend(fjs.EventsSource);fjs.api.TabsSynchronizer.prototype._checkMaster=function(){var a;a=fjs.utils.Browser.isIE11()?fjs.utils.Cookies.get(this.TABS_SYNCRONIZE_KEY):localStorage.getItem(this.TABS_SYNCRONIZE_KEY);return!a||Date.now()-parseInt(a.split("|")[1])>this.CHANGE_TAB_TIMEOUT};fjs.api.TabsSynchronizer.prototype.addEventListener=function(a,b){var d=this;fjs.utils.Browser.isIE11()&&
"master_changed"!=a&&(this.lastValues[a]||(this.lastValues[a]=[]),this.cookiesSynchronizationRuned||(this.db=(new fjs.db.DBFactory).getDB(),setInterval(function(){for(var a in d.lastValues){var b=d.lastValues[a];1==d.db.state&&function(b){d.db.selectByIndex("tabsync",{eventType:a},function(){},function(a){if(a){a.sort(function(a,b){return a.order>b.order?1:a.order<b.order?-1:0});for(var c=0;c<a.length;c++){var e=a[c],f=e.key,g=f.split("|");0>b.indexOf(f)&&g[1]!=d.tabId&&(d.fireEvent(e.eventType,{key:e.eventType,
newValue:e.val}),b.push(f),function(a){setTimeout(function(){var c=b.indexOf(a);0<=c&&b.splice(c,1)},1E4)}(f))}}})}(b)}},1E3)));this.superClass.addEventListener.call(this,a,b)};fjs.api.TabsSynchronizer.prototype.removeEventListener=function(a,b){fjs.utils.Browser.isIE11()&&delete this.lastValues[a];this.superClass.removeEventListener.call(this,a,b)};fjs.api.TabsSynchronizer.prototype.generateDataKey=function(a){var b=new fjs.utils.Increment;return a+"|"+this.tabId+"|"+b.get("tabsyncKeys")};fjs.api.TabsSynchronizer.prototype.setSyncValue=
function(a,b){if(this.db&&1==this.db.state){var d=this.generateDataKey(a),c=this,e=new fjs.utils.Increment;this.db.insertOne("tabsync",{key:d,eventType:a,val:b,order:Date.now()+""+e});setTimeout(function(){c.db.deleteByKey("tabsync",d)},1E4)}}})();
